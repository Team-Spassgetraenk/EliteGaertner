@page "/"
@layout Layout.MainLayout
@using AppLogic.Interfaces
@using PresentationLayer.State
@inject ILogger<Login> Logger
@inject IProfileMgm ProfileMgm
@inject CurrentProfileState CurrentProfile
@inject NavigationManager Nav


<link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&display=swap" rel="stylesheet">

<div class="login-page-container">
    <div class="login-center">
        

        <div class="login-card">
            
            @* Info Icon *@
            <div class="info-icon" @onclick="GoToUeberUns" title="Über EliteGärtner">
                i
            </div>

            <div class="logo-container">
                <img src="pictures/EliteGärtner_logo.png" alt="EliteGärtner Logo" class="app-logo"/>
                <h2 class="elitegaertner-title mt-2" style="font-weight: 600; font-size: 2.5rem;">EliteGärtner.</h2>
            </div>

            <div class="input-group">
                <label for="email-input">Email</label>
                <input id="email-input" class="app-input" placeholder="Email eingeben..." @bind="_email" @bind:event="oninput"/>
            </div>

            <div class="input-group">
                <label for="password-input">Passwort</label>
                <input id="password-input" class="app-input" type="password" placeholder="Passwort eingeben..." @bind="_password" @bind:event="oninput"/>
            </div>

            <button class="app-button primary-button"
                    @onclick="Einloggen"
                    disabled="@(!LoginEnabled)">
                Anmelden
            </button>

            @if (!LoginEnabled)
            {
                <p class="disabled-hint">Bitte zuerst E-Mail und Passwort eingeben.</p>
            }

            @* Falls Exception (Login falsch) geworfen wird *@
            @if (!string.IsNullOrWhiteSpace(_errorMessage))
            {
                <p class="error-message">@_errorMessage</p>
            }

            <div class="register-text">
                <p>Ich habe noch keinen Account?</p>
                <a href="/registrierung" class="register-link">Jetzt registrieren</a>
            </div>

        </div>

    </div>
</div>

@code {
    string _email = "";
    string _password = "";
    string _errorMessage = "";

    //Sind beide Felder gefüllt?
    private bool LoginEnabled =>
        !string.IsNullOrWhiteSpace(_email) &&
        !string.IsNullOrWhiteSpace(_password);
    
    private void Einloggen()
    {
        if (!LoginEnabled)
            return;

        _errorMessage = ""; // Reset

        Logger.LogInformation(
            "Login attempt started for email {Email}",
            _email
        );

        try
        {
            var loginDto = new CredentialProfileDto
            {
                EMail = _email,
                PasswordHash = _password
            };

            var loggedInProfile = ProfileMgm.LoginProfile(loginDto);

            //Loggin fehlgeschlagen
            if (loggedInProfile is null || loggedInProfile.ProfileId <= 0)
            {
                Logger.LogWarning(
                    "Login failed for email {Email} – no valid profile returned",
                    _email
                );

                _errorMessage = "Login fehlgeschlagen.";
                return;
            }

            // Erfolg
            Logger.LogInformation(
                "Login successful for ProfileId {ProfileId} (Email {Email})",
                loggedInProfile.ProfileId,
                _email
            );

            CurrentProfile.Login(loggedInProfile);
            Nav.NavigateTo("/startseite");
        }
        catch (UnauthorizedAccessException ex)
        {
            Logger.LogWarning(
                ex,
                "Unauthorized login attempt for email {Email}",
                _email
            );

            _errorMessage = ex.Message;
        }
        catch (Exception ex)
        {
            Logger.LogError(
                ex,
                "Technical error during login for email {Email}",
                _email
            );

            _errorMessage = "Technischer Fehler beim Login.";
        }
    }
    
    //Navigation
    private void GoToUeberUns()
    {
        Logger.LogInformation("Login: Navigation -> Ueber-uns-Login.");
        Nav.NavigateTo("/ueber-uns-login");
    }
    
}