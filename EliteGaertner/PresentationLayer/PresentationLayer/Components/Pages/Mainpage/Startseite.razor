@page "/startseite"
@using AppLogic.Interfaces
@using AppLogic.Services
@using DataManagement.Interfaces
@using PresentationLayer.State
@using PresentationLayer.Shared
@using System.Timers
@inject CurrentProfileState CurrentProfile
@inject IHarvestDbs HarvestDbs
@inject IMatchesDbs MatchesDbs
@inject IProfileDbs ProfileDbs
@inject IJSRuntime JS
@inject NavigationManager Nav
@implements IDisposable


<link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&display=swap" rel="stylesheet">

<div class="page-container background-style">
    <header class="top-bar">
        @* Linke Seite *@
        <div class="icon-wrapper left" @onclick="GoToRanks">
            <img src="pictures/Rangliste.png" alt="Rangliste" height="40" />
            <span class="icon-label">Rangliste</span>
        </div>

        @* Mitte (wird durch CSS absolut zentriert) *@
        <h1 class="page-title">EliteG√§rtner.</h1>

        @* Rechte Seite *@
        <div class="header-right-group" style="display: flex; align-items: center; gap: 20px;">
            @if (!string.IsNullOrEmpty(_loggedInUserName))
            {
                <span class="logged-in-user" style="font-weight: bold; font-size: 1.5rem;">
                    üë§ @_loggedInUserName
                </span>
            }
            <div class="menu-icon-container" @onclick="ToggleLogoutMenu">
                <span class="menu-icon">‚ò∞</span>
            </div>
        </div>
    </header>

    @if (_showAd)
    {
    <div class="ad-sidebar">
        <div class="ad-header">
            <span class="ad-label">Anzeige</span>
            <span class="ad-close" @onclick="CloseAd">‚úñ</span>
        </div>
        <div class="ad-content">
            <img src="@_currentAdImage" alt="Werbung" class="ad-image" />
        </div>
    </div>
    }

    @if (_showMatchOverlay)
    {
        <div class="match-overlay">
            @* Konfetti-Loop *@
            @for (int i = 0; i < 60; i++)
            {
                // Zuf√§llige Flugrichtung in alle Richtungen
                var x = Random.Shared.Next(-500, 500);
                var y = Random.Shared.Next(-500, 500);
                <div class="confetti" style="--x: @(x)px; --y: @(y)px; background-color: @(_confettiColors[Random.Shared.Next(0, _confettiColors.Length)])"></div>
            }

            <div class="match-content">
                <h2 class="match-title">IT'S A MATCH!</h2>
                <p class="match-subtitle">Gl√ºckwunsch!!! 
                    Du und @_matchedUser?.UserName seid jetzt ein Team!</p>

                <div class="match-images">
                    <div class="match-photo-circle left-photo">
                        <img src="pictures/Profilbilder/Profilbild_27.png" alt="Dein Profil" style="width:100%; height:100%; object-fit:cover;" />
                    </div>
                    <div class="match-photo-circle right-photo">
                        <img src="@_matchedUser?.ProfilepictureUrl" alt="Match Profil" style="width:100%; height:100%; object-fit:cover;" />
                    </div>
                </div>

                <div class="match-actions">
                    <button class="match-btn contact-btn" @onclick='() => NavTo("/matchestest")'>Kontakt aufnehmen</button>
                    <button class="match-btn continue-btn" @onclick="CloseMatchOverlay">Weiter g√§rtnern</button>
                </div>
            </div>
        </div>
    }

    @if (_showLogout)
    {
    <div class="logout-menu admin-menu-ext">
        <p class="logout-link" @onclick="NavigateToLogout">Logout ‚ûú]</p>
        <div class="admin-header" @onclick="NavigateToAboutUs">
            <span>‚ÑπÔ∏è √úber uns</span>
        </div>
        <div class="admin-nav-section">
            <div class="admin-header" @onclick="ToggleAdminNav">
                <span>üõ† Admin-Navigation</span>
                <span style="font-size: 12px;">@(_showAdminNav ? " ‚ñ≤" : " ‚ñº")</span>
            </div>
            @if (_showAdminNav)
            {
            <div class="admin-scroll-area">
                <div class="admin-link" @onclick='() => NavTo("/")'>Login</div>
                <div class="admin-link" @onclick='() => NavTo("/registrierung")'>Registrierung</div>
                <div class="admin-link" @onclick='() => NavTo("/registrierung/interessen")'>Interessen</div>
                <div class="admin-link" @onclick='() => NavTo("/registrierung/profilerstellung")'>Profilerstellung</div>
                <div class="admin-link" @onclick='() => NavTo("/ernte-hochladen")'>Ernte Upload</div>
                <div class="admin-link" @onclick='() => NavTo("/profiltest")'>Profil (Eigen)</div>
                <div class="admin-link" @onclick='() => NavTo("/profil/profilverwaltung")'>Verwaltung</div>
                <div class="admin-link" @onclick='() => NavTo("/profil/fremder-user")'>Profil (Fremd)</div>
                <div class="admin-link" @onclick='() => NavTo("/startseite")'>Startseite</div>
                <div class="admin-link" @onclick='() => NavTo("/pr√§ferenzeinstellungen")'>Pr√§ferenzen</div>
                <div class="admin-link" @onclick='() => NavTo("/ranglistetest")'>Rangliste</div>
                <div class="admin-link" @onclick='() => NavTo("/matchestest")'>Matches</div>
            </div>
            }
        </div>
    </div>
    }
    @* Standard Vorschlags Karte *@
    <div class="tinder-card-area">
        @if (_isProfileVisible && _currentHarvest != null)
        {
            <div class="tinder-wrapper-card @_animationClass" @key="_cardKey">
                <div class="main-content-flex">
                    <div class="tinder-card">
                        <div class="card-image-placeholder">
                            <img src="@_currentHarvest.ImageUrl" alt="Erntebild" class="harvest-image" />
                        </div>
                        @* --- Profilbild des fremden Users auf der Karte --- *@
                        <div class="user-avatar-on-card">
                            <img src="@_currentHarvest.ProfileImageUrl" alt="User Avatar" />
                        </div>
                        <div class="username-tag-combo">
                            <a class="username-link" href="@($"/profil/{GetUsernameUrl()}")">
                                <span class="username-label">@_currentHarvest.Username</span>
                            </a>
                            <div class="tag-label">
                                <span>@_currentHarvest.Tag</span>
                            </div>
                        </div>
                    </div>
            
                    <div class="right-info-stack">
                        <div class="parameter-wrapper-vertical">
                            <div class="white-comic-box">
                                <div class="param-icon-circle">‚öñÔ∏è</div>
                                <div class="param-content-wrapper">
                                    <p class="param-title">Gewicht</p>
                                    <p class="param-value">@_currentHarvest.Weight</p>
                                </div>
                            </div>
                            <div class="white-comic-box">
                                <div class="param-icon-circle">üìè</div>
                                <div class="param-content-wrapper">
                                    <p class="param-title">L√§nge</p>
                                    <p class="param-value">@_currentHarvest.Length</p>
                                </div>
                            </div>
                            <div class="white-comic-box">
                                <div class="param-icon-circle">üìê</div>
                                <div class="param-content-wrapper">
                                    <p class="param-title">Breite</p>
                                    <p class="param-value">@_currentHarvest.Width</p>
                                </div>
                            </div>
                        </div>
            
                        <div class="comment-box white-comic-box">
                            <p class="comment-label">Erntebeschreibung</p>
                            <p class="comment-text">@_currentHarvest.Description</p>
                        </div>
            
                        <div class="rating-icons-in-stack">
                            <div class="rating-icon flag-icon" @onclick="FlagProfile">
                                <span style="font-size: 20px;">üö©</span>
                            </div>
                            <div class="rating-icon dislike-icon" @onclick="() => HandleSwipe(false)">
                                <span style="font-size: 24px;">‚ùå</span>
                            </div>
                            <div class="rating-icon like-icon" @onclick="() => HandleSwipe(true)">
                                <span style="font-size: 24px;">üíö</span>
                            </div>
                            <div class="rating-icon settings-icon" @onclick="NavigateToPreferences">
                                <img src="pictures/EinstellungenIcon.png" alt="Einstellungen" height="27" />
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }
        @* Report Karte *@
        else if (!_isProfileVisible)
        {
            <div class="white-comic-box @_animationClass"
                 @key="_cardKey"
                 style="text-align: center; padding: 20px;">
                <p>Profil wurde gemeldet und ausgeblendet.</p>
            </div>
        }
        @* "Keine Vorschl√§ge" Karte *@
        else
        {
            <div class="white-comic-box @_animationClass"
                 @key="_cardKey"
                 style="text-align: center; padding: 20px; max-width: 850px; width: 100%;">
                <p style="font-size: 1.4rem; font-weight: bold; margin: 0;">Keine passenden Vorschl√§ge</p>
                <p style="margin-top: 10px;">Passe deine Interessen an oder versuche es sp√§ter erneut.</p>

                <button class="app-button primary-button"
                        style="margin-top: 10px;"
                        @onclick="NavigateToPreferences">
                    Pr√§ferenzen √∂ffnen
                </button>
            </div>
        } 

        @* --- REPORT MODAL --- *@
        @if (_showReportModal)
        {
            <div class="report-modal-overlay">
                <div class="report-modal">
                    <p style="font-weight: bold; margin-bottom: 10px;">Post Melden</p>
                    <div style="max-height: 200px; overflow-y: auto; text-align: left; margin-bottom: 15px;">
                        @foreach (var reason in _reportReasons)
                        {
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                                <input type="checkbox"
                                       @onchange="@(e => UpdateReportReason(reason, e))"
                                       checked="@(_selectedReportReason == reason)" />
                                <label>@GetReportReasonLabel(reason)</label>
                            </div>
                        }
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <button class="report-button" @onclick="ReportProfile">Melden</button>
                        <span class="close-x" @onclick="CloseReportModal">‚úñ</span>
                    </div>
                </div>
            </div>
        }
    </div>

    <footer class="bottom-nav">
        <div class="nav-item active" @onclick="GoToMatches">
            <img src="pictures/MatchesIcon.png" alt="Matches" height="40" />
            <span>Matches</span>
        </div>

        <div class="nav-item" @onclick="GoToMainpage">
            <img src="pictures/EliteG√§rtner_logo.png" alt="EliteG√§rtner" height="40" />
            <span>EliteG√§rtner.</span>
        </div>

        <div class="nav-item" @onclick="GoToProfile">
            <img src="pictures/Profil_04.png" alt="Profile" height="40" />
            <span>Profil</span>
        </div>
    </footer>
</div>


@code {
    // ----------------------------
    // AppLogic (runtime-created)
    // ----------------------------
    private IMatchManager? _matchManager;
    private (PublicProfileDto Creator, HarvestUploadDto Harvest)? _currentSuggestion;

    // ----------------------------
    // UI State
    // ----------------------------
    private string _loggedInUserName = "";

    // Animation / current card
    private string _animationClass = "";
    private bool _isAnimating = false;
    //Ben√∂tigt Blazor um ein komplett neues DOM Element f√ºr die Karte zu bauen
    private int _cardKey = 0;
    private HarvestModel? _currentHarvest;

    // Match overlay
    private bool _showMatchOverlay = false;
    private PublicProfileDto? _matchedUser;
    private readonly string[] _confettiColors = { "#FFC107", "#2196F3", "#FF5722", "#4CAF50", "#E91E63" };

    // Logout/admin menu
    private bool _showLogout = false;
    private bool _showAdminNav = false;

    // Report modal
    private bool _showReportModal = false;
    private bool _isProfileVisible = true;
    private ReportReasons? _selectedReportReason = null;
    private readonly ReportReasons[] _reportReasons =
    {
        ReportReasons.AbstossendeInhalte,
        ReportReasons.SexuelleInhalte,
        ReportReasons.GewaltvolleInhalte,
        ReportReasons.CatFishing,
        ReportReasons.Spam
    };

    // ----------------------------
    // Ads
    // ----------------------------
    private bool _showAd = true;
    private string _currentAdImage = "pictures/ads/pimpyourblechad02.jpg";
    private int _adCounter = 0;
    private Timer? _adTimer;
    private ElapsedEventHandler? _adTimerElapsedHandler;
    private readonly string[] _adImages =
    {
        "pictures/ads/pimpyourblechad02.jpg",
        "pictures/ads/Drachenlord_Schanzenfest_Werbeplakat.jpg",
        "pictures/ads/GurkenStandAd.jpg",
        "pictures/ads/OBI_werbung.jpg",
        "pictures/ads/ralphschuhmacherad.png",
        "pictures/ads/werbeplakat-leberkaessemmel.jpg",
        "pictures/ads/DieLilaVersuchung.jpg",
        "pictures/ads/pimpyourblech01.jpg",
        "pictures/ads/werbeplakat-leberkassemmel02.jpg",
        "pictures/ads/W√ºrstlStandAd.jpg",
        "pictures/ads/pimpyourblechad03.jpg"
    };

    // ----------------------------
    // Lifecycle
    // ----------------------------
    protected override void OnInitialized()
    {
        //TODO KOMMT WEG
        Console.WriteLine("Er kommt zumindest in OnInitialized");
        Console.WriteLine($"STATE(Startseite): {CurrentProfile.InstanceId}");
        
        // Guard: wenn kein Profil im State liegt, sind wir nicht (mehr) eingeloggt.
        // Dann zur√ºck zur Login-Seite, bevor wir UserName/LoggedInProfile verwenden.
        if (CurrentProfile.LoggedInProfile is null)
        {
            //TODO TEST GEH√ñRT WEG
            Console.WriteLine("STARTSEITE GUARD TRIGGERED: LoggedInProfile is null -> redirect to /");

            // optional: noch mehr Kontext
            Console.WriteLine($"IsLoggedIn: {CurrentProfile.IsLoggedIn}");
            Console.WriteLine($"UserName: '{CurrentProfile.UserName}'");
            
            Nav.NavigateTo("/");
            return;
        }
        
        //R√ºckgabe welcher User eingeloggt ist
        _loggedInUserName = "@" + CurrentProfile.UserName;
        
        //MatchManager wird initialisiert
        _matchManager = new MatchManager(
            MatchesDbs,
            ProfileDbs,
            HarvestDbs,
            CurrentProfile.LoggedInProfile
        );
        
        _matchManager.CreateMatch += OnMatchCreated;
        
        //Erste Suggestion laden
        TryLoadNextSuggestion();
        
        //Hier wird der WerbeBlock abgehandelt
        _currentAdImage = _adImages[0];
        _adTimer = new Timer(6000);
        _adTimerElapsedHandler = async (_, _) =>
        {
            _adCounter++;
            _currentAdImage = _adImages[_adCounter % _adImages.Length];
            await InvokeAsync(StateHasChanged);
        };
        _adTimer.Elapsed += _adTimerElapsedHandler;
        _adTimer.AutoReset = true;
        _adTimer.Enabled = true;
    }
    
    //Subscription auf MatchManager Methode l√∂st die Methode aus, falls es zu einem neuen Match kommt
    private async void OnMatchCreated(PublicProfileDto matchProfile)
    {
        _matchedUser = matchProfile;
        _showMatchOverlay = true;
        await PlayMatchSound();
        await InvokeAsync(StateHasChanged);
    }
    
    //Falls Seite verlassen wird
    public void Dispose()
    {
        //-> Create Match Subscription beenden
        if (_matchManager is not null)
            _matchManager.CreateMatch -= OnMatchCreated;
        
        //-> AdTimer beenden
        if (_adTimer is not null)
        {
            _adTimer.Stop();

            if (_adTimerElapsedHandler is not null)
                _adTimer.Elapsed -= _adTimerElapsedHandler;

            _adTimer.Dispose();
            _adTimer = null;
            _adTimerElapsedHandler = null;
        }
    }

    // ----------------------------
    // Card interactions
    // ----------------------------
    private async Task HandleSwipe(bool like)
    {
        //Sperre, wenn Animation l√§uft ODER Match-Overlay offen ist
        if (_isAnimating || _showMatchOverlay)
            return;
        
        //Keine Karte vorhanden
        if (_matchManager is null || _currentSuggestion is null || _currentHarvest is null)
            return;
        
        //Muss true sein, damit Animation √ºberhaupt m√∂glich werden
        _isAnimating = true;

        //Falls der try Block nicht funktioniert -> isAnimating immer sicher zur√ºcksetzen lassen
        //Sonst friert UI ein
        try
        {
            //√Ñnder den State der Karte
            _animationClass = like ? "swipe-right" : "swipe-left";
            //Trigger die Animation
            StateHasChanged();

            //Verz√∂gert das Nachladen der n√§chsten Suggestion, um die Animation durchlaufen zu lassen
            await Task.Delay(600);

            //Holt aus der Tupel das aktelle vorgeschlagene Profil
            var (creator, _) = _currentSuggestion.Value;
            //Ruft die Rate Methode im Match Manager mit dem bewertet Creator und der Bewertung auf
            _matchManager.RateUser(creator, like);

            //Reset der UI, damit keine vorherigen Zust√§nde ungewollt √ºbernommen werden
            ResetUiAfterSwipe();
            //L√§dt die n√§chste Suggestion
            TryLoadNextSuggestion();

            //√Ñnder den State der Karte -> Neuer Vorschlag soll gerendert werden
            _animationClass = "fade-in";
            //Trigger die Animation
            StateHasChanged();

            //Verz√∂gerung, um die Animation durchlaufen zu lassen
            await Task.Delay(400);
            //Wird geleert
            _animationClass = "";
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex);
        }
        finally
        {
            //Animationen sollen nicht mehr m√∂glich sein
            _isAnimating = false;  
        }
    }

    private async Task PlayMatchSound()
    {
        // Spielt Konfetti-Sound ab bei Match
        await JS.InvokeVoidAsync("eval", "new Audio('sounds/itsamatch.mp3').play()");
    }

    private void CloseMatchOverlay() => _showMatchOverlay = false;

    // ----------------------------
    // Ads
    // ----------------------------
    private async Task CloseAd()
    {
        _showAd = false;
        await Task.Delay(10000);
        _showAd = true;
        await InvokeAsync(StateHasChanged);
    }

    // ----------------------------
    // Menus / Navigation
    // ----------------------------
    private void ToggleLogoutMenu()
    {
        _showLogout = !_showLogout;
        if (!_showLogout)
            _showAdminNav = false;
    }

    private void ToggleAdminNav() => _showAdminNav = !_showAdminNav;

    private void NavTo(string path)
    {
        _showLogout = false;
        Nav.NavigateTo(path);
    }

    private void NavigateToAboutUs() => Nav.NavigateTo("/ueber-uns");
    private void NavigateToLogout() => Nav.NavigateTo("/");
    private void NavigateToPreferences() => Nav.NavigateTo("/pr√§ferenzeinstellungen");
    private void GoToRanks() => Nav.NavigateTo("/RanglisteTest");
    private void GoToMatches() => Nav.NavigateTo("/MatchesTest");
    private void GoToMainpage() => Nav.NavigateTo("/startseite");
    private void GoToProfile() => Nav.NavigateTo("/ProfilTest");

    // ----------------------------
    // Report modal
    // ----------------------------
    private void FlagProfile() => _showReportModal = true;
    private void CloseReportModal() => _showReportModal = false;

    //CheckBox Logik im ReportFenster
    private void UpdateReportReason(ReportReasons reason, ChangeEventArgs e)
    {
        //Methode entscheidet in welchen Boolwert √ºbersetzt wird
        var isChecked = e.Value switch
        {
            bool b => b,
            string s when bool.TryParse(s, out var parsed) => parsed,
            _ => false
        };
        
        //Wenn Checkbox angeklickt wird -> Reason setzen
        if (isChecked)
            _selectedReportReason = reason;
        //Wenn Checkbox "geleert" wird -> Reason auf null
        else if (_selectedReportReason == reason) 
            _selectedReportReason = null;
    }

    private async Task ReportProfile()
    {
        //√úberpr√ºfungen
        // Sperre, wenn Animation l√§uft oder Match-Overlay offen ist
        if (_isAnimating || _showMatchOverlay)
            return;
        //MatchManager initialisiert?
        if (_matchManager is null)
            return;
        //Vorschl√§ge vorhanden?
        if (_currentSuggestion is null)
            return;
        //√úberpr√ºft, ob _selectedReportReason einen g√ºltigen Enum Wert besitzt
        //Falls ja -> Enum wird in reason abgespeichert 
        if (_selectedReportReason is not ReportReasons reason)
            return;
        
        //UI sperren damit keine parallelen Klicks registirert werden
        _isAnimating = true;

        try
        {
            //Upload des aktuellen Vorschlags extrahieren
            var creator = _currentSuggestion.Value.Creator;
            var upload = _currentSuggestion.Value.Harvest;

            //Aufruf der Reportmethode des MatchManagers
            _matchManager.ReportHarvestUpload(upload.UploadId, reason);
            //Profil wird negativ bewertet -> Vorschlag wird entfernt
            _matchManager.RateUser(creator, false);

            //Report Fenster wird geschlossen
            _showReportModal = false;
            //Reason wird zur√ºckgesetzt
            _selectedReportReason = null;

            //Nach links swipen
            _animationClass = "swipe-left";
            //Trigger der Animation
            StateHasChanged();
            //Warten bis Animation durchgef√ºhrt wird
            await Task.Delay(600);

            //Reset der Animation
            _animationClass = "";
            StateHasChanged();

            //Report Karte anzeigen 
            _cardKey++;
            _isProfileVisible = false;
            //Fade-In f√ºr die neue Karte
            _animationClass = "fade-in";
            //Trigger der Animation
            StateHasChanged();
            //Warten bis die Animation durchgef√ºhrt wird
            await Task.Delay(400);

            //Animation "leeren"
            _animationClass = "";
            //Animation triggern
            StateHasChanged();
            //Es soll drei Sekunden gewartet werden bis der n√§chste Vorschlag gerendert wird
            await Task.Delay(3000);

            //UI Reset + n√§chsten Vorschlag laden
            ResetUiAfterSwipe();
            TryLoadNextSuggestion();

            //Fade-In f√ºr die neue Karte
            _animationClass = "fade-in";
            //Trigger der Animation
            StateHasChanged();
            //Warten bis die Animation durchgef√ºhrt wird
            await Task.Delay(400);

            //Animation "leeren"
            _animationClass = "";
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex);
            _animationClass = "";
            StateHasChanged();
        }
        finally
        {
            //IsAnimating wird wieder auf falsch gesetzt
            _isAnimating = false;
        }
    }

    //Resetted die UI nach einem Swipe, da sonst Zwischenst√§nde in die n√§chste UI gezogen werden k√∂nnten
    private void ResetUiAfterSwipe()
    {
        _showReportModal = false;
        _selectedReportReason = null;
        _isProfileVisible = true;
    }

    // ----------------------------
    // Helpers
    // ----------------------------
    private string GetUsernameUrl() => _currentHarvest?.Username.TrimStart('@') ?? "";
    
    private void LoadNextSuggestion()
    {
        //Zeigt die Standard VorschlagsKarte an
        _isProfileVisible = true;
        
        //Methode abbrechen, falls MatchManager nicht initialisiert ist
        //Zeigt die "Keine Vorschl√§ge" Karte an
        if (_matchManager is null)
        {
            LoadEmptySuggestion();
            return;
        }
        
        //Gib mir den ersten Eintrag aus der Vorschlagsliste zur√ºck
        var next = _matchManager.GetNextSuggestion();
        
        //Falls Vorschlagsliste leeren Key zur√ºckgibt -> 
        //Zeigt die "Keine Vorschl√§ge" Karte an
        if (next is null)
        {
            LoadEmptySuggestion();
            return;
        }
        
        //Speicher Profil + Upload in currenSuggestion ab
        _currentSuggestion = (next.Value.creator, next.Value.harvest);
        
        //Hier entziehen wir dem HarvestUpload die TagId und geben uns von dem TagCatalog 
        //den passenden String zur√ºck
        //Falls TagIds null ist -> weise 0 zu
        var firstTagId = next.Value.harvest.TagIds?.FirstOrDefault() ?? 0;
        var tagItem = firstTagId > 0 ? TagCatalog.FindById(firstTagId) : null;
        
        //Erstell aus dem Vorschlag das Harvestmodel, dass von Blazor dementsprechend gerendert wird
        _currentHarvest = new HarvestModel
        {
            Username = "@" + next.Value.creator.UserName,
            ProfileImageUrl = next.Value.creator.ProfilepictureUrl,
            ImageUrl = next.Value.harvest.ImageUrl,
            Description = next.Value.harvest.Description,
            Weight = $"{next.Value.harvest.WeightGram} g",
            Length = $"{next.Value.harvest.LengthCm} cm",
            Width = $"{next.Value.harvest.WidthCm} cm",
            Tag = tagItem is null ? "" : $"{tagItem.Icon} {tagItem.Name}"
        };

        //Blazor wei√ü damit, dass hier ein neues Dom Element gerendert werden soll
        _cardKey++;
    }
    
    private void TryLoadNextSuggestion()
    {
        try
        {
            LoadNextSuggestion();
        }
        catch (Exception ex)
        {
            Console.WriteLine("Startseite LoadNextSuggestion crashed:");
            Console.WriteLine(ex);
            LoadEmptySuggestion();
            StateHasChanged(); // optional, aber hilft sofort UI zu aktualisieren
        }
    }
    
    private void LoadEmptySuggestion()
    {
        _currentSuggestion = null;
        _currentHarvest = null;
        _cardKey++;
    }

    //Das Mappen der Enumeration mit den Strings, die auf der Webseite gerendert werden
    private static string GetReportReasonLabel(ReportReasons reason)
        => reason switch
        {
            ReportReasons.AbstossendeInhalte => "Abstossende Inhalte",
            ReportReasons.SexuelleInhalte => "Sexuelle Inhalte",
            ReportReasons.GewaltvolleInhalte => "Gewaltvolle Inhalte",
            ReportReasons.CatFishing => "Catfishing - nicht selbst angebaut",
            ReportReasons.Spam => "Spam",
            //Unterstrich ist Default
            _=> reason.ToString()
        };


    private sealed class HarvestModel
    {
        public string Username { get; set; } = "";
        public string Tag { get; set; } = "";
        public string ImageUrl { get; set; } = "";
        public string ProfileImageUrl { get; set; } = "";
        public string Weight { get; set; } = "";
        public string Length { get; set; } = "";
        public string Width { get; set; } = "";
        public string Description { get; set; } = "";
    }
}