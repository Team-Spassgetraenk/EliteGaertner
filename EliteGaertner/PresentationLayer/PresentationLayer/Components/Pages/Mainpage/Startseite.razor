@page "/startseite"
@using Microsoft.AspNetCore.Components.Web
@using System.Timers
@inject NavigationManager Nav
@implements IDisposable
@rendermode InteractiveServer

<link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&display=swap" rel="stylesheet">

<div class="page-container background-style">
    <header class="top-bar">

        <div class="icon-wrapper left" @onclick="GoToRanks">
            <img src="pictures/Rangliste.png" alt="Rangliste" height="40" />
            <span class="icon-label">Rangliste</span>
        </div>
        
        <h1 class="page-title">EliteG√§rtner.</h1>


        <div class="menu-icon-container">
            <span class="menu-icon" @onclick="ToggleLogoutMenu">‚ò∞</span>
        </div>
    </header>
    
    @* --- WERBE-CONTAINER RECHTS --- *@
    @if (_showAd)
    {
        <div class="ad-sidebar">
            <div class="ad-header">
                <span class="ad-label">Anzeige</span>
                <span class="ad-close" @onclick="CloseAd">‚úñ</span>
            </div>
            <div class="ad-content">
                <img src="@_currentAdImage" alt="Werbung" class="ad-image" />
            </div>
        </div>
    }

    @* --- NEUES KOMBINIERTES LOGOUT & ADMIN MEN√ú --- *@
    @if (_showLogout)
    {
    <div class="logout-menu admin-menu-ext">
        @* Roter Logout Button *@
        <p class="logout-link" @onclick="NavigateToLogout">Logout ‚ûú]</p>
        
        @* √úber uns Button *@
        <div class="admin-header" @onclick="NavigateToAboutUs" style="cursor: pointer; border-bottom: 1px solid #ddd; margin-bottom: 5px;">
            <span>‚ÑπÔ∏è √úber uns</span>
        </div>
        
        <div class="admin-nav-section">
            <div class="admin-header" @onclick="ToggleAdminNav">
                <span>üõ† Admin-Navigation</span>
                <span style="font-size: 12px;">@(_showAdminNav ? " ‚ñ≤" : " ‚ñº")</span>
            </div>
            
            @if (_showAdminNav)
            {
                <div class="admin-scroll-area">
                    <div class="admin-link" @onclick='() => NavTo("/")'>Login</div>
                    <div class="admin-link" @onclick='() => NavTo("/registrierung")'>Registrierung</div>
                    <div class="admin-link" @onclick='() => NavTo("/registrierung/interessen")'>Interessen</div>
                    <div class="admin-link" @onclick='() => NavTo("/registrierung/profilerstellung")'>Profilerstellung</div>
                    <div class="admin-link" @onclick='() => NavTo("/ernte-hochladen")'>Ernte Upload</div>
                    <div class="admin-link" @onclick='() => NavTo("/profiltest")'>Profil (Eigen)</div>
                    <div class="admin-link" @onclick='() => NavTo("/profil/profilverwaltung")'>Verwaltung</div>
                    <div class="admin-link" @onclick='() => NavTo("/profil/fremder-user")'>Profil (Fremd)</div>
                    <div class="admin-link" @onclick='() => NavTo("/startseite")'>Startseite</div>
                    <div class="admin-link" @onclick='() => NavTo("/pr√§ferenzeinstellungen")'>Pr√§ferenzen</div>
                    <div class="admin-link" @onclick='() => NavTo("/ranglistetest")'>Rangliste</div>
                    <div class="admin-link" @onclick='() => NavTo("/matchestest")'>Matches</div>
                </div>
            }
        </div>
    </div>
    }

    <div class="tinder-card-area">
        @if (_isProfileVisible)
        {
        <div class="tinder-wrapper-card">

            @* Bild und Info-Spalte nebeneinander *@
            <div class="main-content-flex">

                @* --- 1. Linke Spalte: Bild mit kombinierter Username/Tag-Leiste --- *@
                <div class="tinder-card">
                    <div class="card-image-placeholder">
                        <img src="pictures/Testbilder/Mais_03.png" alt="Erntebild" class="harvest-image" />
                    </div>

                    @* Kombiniertes Feld f√ºr anklickbaren Username und Tag (Oben links/rechts) *@
                    <div class="username-tag-combo">
                        @* ANKLICKBARER USERNAME *@
                        <a class="username-link" href="@($"/profil/{GetUsernameUrl()}")">
                            <span class="username-label">@_userName1</span>
                        </a>

                        <div class="tag-label">
                            <span>Gurken ü•í</span>
                        </div>
                    </div>
                </div>

                @* 2. Rechte Spalte: Parameter (gestapelt), Kommentar und Buttons *@
                <div class="right-info-stack">

                    @* Parameter Felder (Gewicht & Gr√∂√üe) *@
                    <div class="parameter-wrapper-vertical">
                        <div class="white-comic-box">
                            <div class="param-icon-circle">
                                <span>‚öñÔ∏è</span>
                            </div>
                            <div class="param-content-wrapper">
                                <p class="param-title">Gewicht</p>
                                <p class="param-value">300 g</p>
                            </div>
                        </div>
                        <div class="white-comic-box">
                            <div class="param-icon-circle">
                                <span>üìè</span>
                            </div>
                            <div class="param-content-wrapper">
                                <p class="param-title">L√§nge</p>
                                <p class="param-value">25 cm</p>
                            </div>
                        </div>
                        <div class="white-comic-box">
                            <div class="param-icon-circle">
                                <span>üìê</span>
                            </div>
                            <div class="param-content-wrapper">
                                <p class="param-title">Breite</p>
                                <p class="param-value">67 cm</p>
                            </div>
                        </div>
                    </div>

                    @* Beschreibung *@
                    <div class="comment-box white-comic-box">
                        <p class="comment-label">Erntebeschreibung</p>
                        <p class="comment-text">Hier k√∂nnte ein Kommentar zur Ernte stehen, der maximal 150 Zeichen umfasst und alle relevanten Infos kurz, pr√§zise und √ºbersichtlich vermittelt...</p>
                    </div>

                    @* Bewertungs-Icons *@
                    <div class="rating-icons-in-stack">
                        <div class="rating-icon flag-icon" @onclick="FlagProfile">
                            <span style="font-size: 20px;">üö©</span>
                        </div>
                        <div class="rating-icon dislike-icon" @onclick="DislikeProfile">
                            <span style="font-size: 24px;">‚ùå</span>
                        </div>
                        <div class="rating-icon like-icon" @onclick="LikeProfile">
                            <span style="font-size: 24px;">üíö</span>
                        </div>
                        <div class="rating-icon settings-icon" @onclick="NavigateToPreferences">
                            <img src="pictures/EinstellungenIcon.png" alt="Matches" height="27" />
                        </div>
                    </div>
                </div>
            </div>
        </div>
        }
        else
        {
        <p style="font-size: 18px; font-weight: bold; text-align: center;">
            Profil wurde gemeldet und ausgeblendet.
        </p>
        }

        @if (_showReportModal)
        {
        <div class="report-modal-overlay">
            <div class="report-modal">

                <p style="font-weight: bold; margin-bottom: 10px;">Post Melden</p>

                @foreach (var reason in _reportReasons)
                {
                    var id = reason.GetHashCode();

                    <div class="report-reason">
                        <input type="checkbox"
                               id="@id"
                               @onchange="@(e => UpdateReportReason(reason, e))"
                               checked="@(_selectedReportReason == reason)" />
                        <label for="@id">@reason</label>
                    </div>
                }
                
                <div class="modal-actions">
                    <button class="report-button" @onclick="ReportProfile">Melden</button>
                    <div class="close-modal-icon" @onclick="CloseReportModal">
                        <span style="font-size: 10px;">‚ùå</span>
                    </div>
                </div>
            </div>
        </div>
        }

    </div>

    <footer class="bottom-nav">
        <div class="nav-item active" @onclick="GoToMatches">
            <img src="pictures/MatchesIcon.png" alt="Matches" height="40" />
            <span>Matches</span>
        </div>

        <div class="nav-item" @onclick="GoToMainpage">
            <img src="pictures/EliteG√§rtner_logo.png" alt="EliteG√§rtner" height="40" />
            <span class="elitegaertner-title mt-2" style="font-weight: 600; font-size: 1.0rem">EliteG√§rtner.</span>
        </div>

        <div class="nav-item" @onclick="GoToProfile">
            <img src="pictures/Profil_04.png" alt="Profile" height="40" />
            <span>Profil</span>
        </div>
    </footer>
</div>

@code {
    private bool _showLogout = false;
    private bool _showAboutUs = false;
    private bool _showAdminNav = false; 
    private bool _showReportModal = false;
    private bool _isProfileVisible = true;
    private string _selectedReportReason = "";
    private string _userName1 = "@user_name1";
    private readonly string[] _reportReasons =
    {
        "Sieht aus wie ein Stockfoto.",
        "Beschreibung passt nicht zum Bild.",
        "Verdacht auf Fake-Upload.",
        "Mehrfach hochgeladenes Bild.",
        "Zu dunkel aufgenommen, schwer erkennbar.",
        "Kategorie wirkt unpassend f√ºr das Bild.", 
        "Text enth√§lt unpassende Formulierungen.", 
        "Bildqualit√§t ist zu niedrig.", 
        "Vermutlich nicht selbst angebaut.", 
        "Kein Obst, geh√∂rt eher in Gem√ºse-Kategorie."
    };

    /* Werbe-Logik */
    private bool _showAd = true;
    private string _currentAdImage = "pictures/ads/pimpyourblechad02.jpg";
    private int _adCounter = 0;
    private Timer? _adTimer;
    private string[] _adImages = new[] 
    { 
        "pictures/ads/pimpyourblechad02.jpg",
        "pictures/ads/Drachenlord_Schanzenfest_Werbeplakat.jpg",
        "pictures/ads/GrukenStandAd.jpg",
        "pictures/ads/OBI_werbung.jpg",
        "pictures/ads/ralphschumacherad.png",
        "pictures/ads/werbeplakat-leberkaessemmel.jpg",
        "pictures/ads/DieLilaVersuchung.jpg",
        "pictures/ads/pimpyourblech01.jpg",
        "pictures/ads/werbeplakat-leberkassemmel02.jpg",
        "pictures/ads/W√ºrstlStandAd.jpg",
        "pictures/ads/pimpyourblechad03.jpg"
    };

    protected override void OnInitialized()
    {
        _currentAdImage = _adImages[0];
        _adTimer = new Timer(6000); //6 sekunden pause zwischen jeder werbung
        _adTimer.Elapsed += async (sender, e) =>
        {
            _adCounter++;
            _currentAdImage = _adImages[_adCounter % _adImages.Length];
            await InvokeAsync(StateHasChanged);
        };
        _adTimer.AutoReset = true;
        _adTimer.Enabled = true;
    }

    private async Task CloseAd() 
    { 
        _showAd = false; 
        await Task.Delay(10000); // 10 Sek Pause
        _showAd = true;
        await InvokeAsync(StateHasChanged);
    }

    public void Dispose() => _adTimer?.Dispose();

private void ToggleLogoutMenu()
{
    _showLogout = !_showLogout;
    if (!_showLogout) _showAdminNav = false;
}

private void ToggleAdminNav() => _showAdminNav = !_showAdminNav;

private void NavTo(string path)
{
    _showLogout = false;
    Nav.NavigateTo(path, forceLoad: true);
}

private void NavigateToAboutUs() => Nav.NavigateTo("/ueber-uns", forceLoad: true);
private void NavigateToLogout() => Nav.NavigateTo("/", forceLoad: true);
private void NavigateToPreferences() => Nav.NavigateTo("/pr√§ferenzeinstellungen", forceLoad: true);
private void GoToRanks() => Nav.NavigateTo("/RanglisteTest", forceLoad: true);
private void GoToMatches() => Nav.NavigateTo("/MatchesTest", forceLoad: true);
private void GoToMainpage() => Nav.NavigateTo("/startseite", forceLoad: true);
private void GoToProfile() => Nav.NavigateTo("/ProfilTest", forceLoad: true);
private void FlagProfile() => _showReportModal = true;
private void CloseReportModal() => _showReportModal = false;

private void UpdateReportReason(string reason, ChangeEventArgs e)
{
    if ((bool)e.Value) _selectedReportReason = reason;
    else if (_selectedReportReason == reason) _selectedReportReason = string.Empty;
}

private void ReportProfile()
{
    if (!string.IsNullOrEmpty(_selectedReportReason))
    {
        _isProfileVisible = false;
        _showReportModal = false;
    }
}

private void DislikeProfile() => Console.WriteLine("0");
private void LikeProfile() => Console.WriteLine("1");
private string GetUsernameUrl() => _userName1.TrimStart('@');
}