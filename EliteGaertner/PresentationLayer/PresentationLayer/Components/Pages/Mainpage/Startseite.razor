@page "/startseite"
@using Microsoft.AspNetCore.Components.Web
@using System.Timers
@inject NavigationManager Nav
@inject IJSRuntime JS
@implements IDisposable
@rendermode InteractiveServer

<link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&display=swap" rel="stylesheet">

<div class="page-container background-style">
    <header class="top-bar">
        @* Linke Seite *@
        <div class="icon-wrapper left" @onclick="GoToRanks">
            <img src="pictures/Rangliste.png" alt="Rangliste" height="40" />
            <span class="icon-label">Rangliste</span>
        </div>

        @* Mitte (wird durch CSS absolut zentriert) *@
        <h1 class="page-title">EliteG√§rtner.</h1>

        @* Rechte Seite *@
        <div class="header-right-group" style="display: flex; align-items: center; gap: 20px;">
            @if (!string.IsNullOrEmpty(_loggedInUserName))
            {
                <span class="logged-in-user" style="font-weight: bold; font-size: 1.5rem;">
                    üë§ @_loggedInUserName
                </span>
            }
            <div class="menu-icon-container" @onclick="ToggleLogoutMenu">
                <span class="menu-icon">‚ò∞</span>
            </div>
        </div>
    </header>

    @if (_showAd)
    {
    <div class="ad-sidebar">
        <div class="ad-header">
            <span class="ad-label">Anzeige</span>
            <span class="ad-close" @onclick="CloseAd">‚úñ</span>
        </div>
        <div class="ad-content">
            <img src="@_currentAdImage" alt="Werbung" class="ad-image" />
        </div>
    </div>
    }

    @if (_showMatchOverlay)
    {
        <div class="match-overlay">
            @* Konfetti-Loop *@
            @for (int i = 0; i < 60; i++)
            {
                // Zuf√§llige Flugrichtung in alle Richtungen
                var x = Random.Shared.Next(-500, 500);
                var y = Random.Shared.Next(-500, 500);
                <div class="confetti" style="--x: @(x)px; --y: @(y)px; background-color: @(_confettiColors[Random.Shared.Next(0, _confettiColors.Length)])"></div>
            }

            <div class="match-content">
                <h2 class="match-title">IT'S A MATCH!</h2>
                <p class="match-subtitle">Gl√ºckwunsch!!! 
                    Du und @_matchedUser?.Username seid jetzt ein Team!</p>

                <div class="match-images">
                    <div class="match-photo-circle left-photo">
                        <img src="pictures/Profilbilder/Profilbild_27.png" alt="Dein Profil" style="width:100%; height:100%; object-fit:cover;" />
                    </div>
                    <div class="match-photo-circle right-photo">
                        <img src="@_matchedUser?.ProfileImageUrl" alt="Match Profil" style="width:100%; height:100%; object-fit:cover;" />
                    </div>
                </div>

                <div class="match-actions">
                    <button class="match-btn contact-btn" @onclick='() => NavTo("/matchestest")'>Kontakt aufnehmen</button>
                    <button class="match-btn continue-btn" @onclick="CloseMatchOverlay">Weiter g√§rtnern</button>
                </div>
            </div>
        </div>
    }

    @if (_showLogout)
    {
    <div class="logout-menu admin-menu-ext">
        <p class="logout-link" @onclick="NavigateToLogout">Logout ‚ûú]</p>
        <div class="admin-header" @onclick="NavigateToAboutUs">
            <span>‚ÑπÔ∏è √úber uns</span>
        </div>
        <div class="admin-nav-section">
            <div class="admin-header" @onclick="ToggleAdminNav">
                <span>üõ† Admin-Navigation</span>
                <span style="font-size: 12px;">@(_showAdminNav ? " ‚ñ≤" : " ‚ñº")</span>
            </div>
            @if (_showAdminNav)
            {
            <div class="admin-scroll-area">
                <div class="admin-link" @onclick='() => NavTo("/")'>Login</div>
                <div class="admin-link" @onclick='() => NavTo("/registrierung")'>Registrierung</div>
                <div class="admin-link" @onclick='() => NavTo("/registrierung/interessen")'>Interessen</div>
                <div class="admin-link" @onclick='() => NavTo("/registrierung/profilerstellung")'>Profilerstellung</div>
                <div class="admin-link" @onclick='() => NavTo("/ernte-hochladen")'>Ernte Upload</div>
                <div class="admin-link" @onclick='() => NavTo("/profiltest")'>Profil (Eigen)</div>
                <div class="admin-link" @onclick='() => NavTo("/profil/profilverwaltung")'>Verwaltung</div>
                <div class="admin-link" @onclick='() => NavTo("/profil/fremder-user")'>Profil (Fremd)</div>
                <div class="admin-link" @onclick='() => NavTo("/startseite")'>Startseite</div>
                <div class="admin-link" @onclick='() => NavTo("/pr√§ferenzeinstellungen")'>Pr√§ferenzen</div>
                <div class="admin-link" @onclick='() => NavTo("/ranglistetest")'>Rangliste</div>
                <div class="admin-link" @onclick='() => NavTo("/matchestest")'>Matches</div>
            </div>
            }
        </div>
    </div>
    }

    <div class="tinder-card-area">
        @if (_isProfileVisible && _currentHarvest != null)
        {
        <div class="tinder-wrapper-card @_animationClass" @key="_harvestIndex">
            <div class="main-content-flex">
                <div class="tinder-card">
                    <div class="card-image-placeholder">
                        <img src="@_currentHarvest.ImageUrl" alt="Erntebild" class="harvest-image" />
                    </div>
                    @* --- Profilbild des fremden Users auf der Karte --- *@
                    <div class="user-avatar-on-card">
                        <img src="@_currentHarvest.ProfileImageUrl" alt="User Avatar" />
                    </div>
                    <div class="username-tag-combo">
                        <a class="username-link" href="@($"/profil/{GetUsernameUrl()}")">
                            <span class="username-label">@_currentHarvest.Username</span>
                        </a>
                        <div class="tag-label">
                            <span>@_currentHarvest.Tag</span>
                        </div>
                    </div>
                </div>

                <div class="right-info-stack">
                    <div class="parameter-wrapper-vertical">
                        <div class="white-comic-box">
                            <div class="param-icon-circle">‚öñÔ∏è</div>
                            <div class="param-content-wrapper">
                                <p class="param-title">Gewicht</p>
                                <p class="param-value">@_currentHarvest.Weight</p>
                            </div>
                        </div>
                        <div class="white-comic-box">
                            <div class="param-icon-circle">üìè</div>
                            <div class="param-content-wrapper">
                                <p class="param-title">L√§nge</p>
                                <p class="param-value">@_currentHarvest.Length</p>
                            </div>
                        </div>
                        <div class="white-comic-box">
                            <div class="param-icon-circle">üìê</div>
                            <div class="param-content-wrapper">
                                <p class="param-title">Breite</p>
                                <p class="param-value">@_currentHarvest.Width</p>
                            </div>
                        </div>
                    </div>

                    <div class="comment-box white-comic-box">
                        <p class="comment-label">Erntebeschreibung</p>
                        <p class="comment-text">@_currentHarvest.Description</p>
                    </div>

                    <div class="rating-icons-in-stack">
                        <div class="rating-icon flag-icon" @onclick="FlagProfile">
                            <span style="font-size: 20px;">üö©</span>
                        </div>
                        <div class="rating-icon dislike-icon" @onclick="() => HandleSwipe(false)">
                            <span style="font-size: 24px;">‚ùå</span>
                        </div>
                        <div class="rating-icon like-icon" @onclick="() => HandleSwipe(true)">
                            <span style="font-size: 24px;">üíö</span>
                        </div>
                        <div class="rating-icon settings-icon" @onclick="NavigateToPreferences">
                            <img src="pictures/EinstellungenIcon.png" alt="Einstellungen" height="27" />
                        </div>
                    </div>
                </div>
            </div>
        </div>
        }
        else if (!_isProfileVisible)
        {
            <div class="white-comic-box" style="text-align: center; padding: 20px;">
                <p>Profil wurde gemeldet und ausgeblendet.</p>
                <button class="report-button" @onclick="() => _isProfileVisible = true">Weiter</button>
            </div>
        }

        @* --- REPORT MODAL --- *@
        @if (_showReportModal)
        {
            <div class="report-modal-overlay">
                <div class="report-modal">
                    <p style="font-weight: bold; margin-bottom: 10px;">Post Melden</p>
                    <div style="max-height: 200px; overflow-y: auto; text-align: left; margin-bottom: 15px;">
                        @foreach (var reason in _reportReasons)
                        {
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                                <input type="checkbox" @onchange="@(e => UpdateReportReason(reason,e))" checked="@(_selectedReportReason == reason)" />
                                <label>@reason</label>
                            </div>
                        }
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <button class="report-button" @onclick="ReportProfile">Melden</button>
                        <span class="close-x" @onclick="CloseReportModal">‚úñ</span>
                    </div>
                </div>
            </div>
        }
    </div>

    <footer class="bottom-nav">
        <div class="nav-item active" @onclick="GoToMatches">
            <img src="pictures/MatchesIcon.png" alt="Matches" height="40" />
            <span>Matches</span>
        </div>

        <div class="nav-item" @onclick="GoToMainpage">
            <img src="pictures/EliteG√§rtner_logo.png" alt="EliteG√§rtner" height="40" />
            <span>EliteG√§rtner.</span>
        </div>

        <div class="nav-item" @onclick="GoToProfile">
            <img src="pictures/Profil_04.png" alt="Profile" height="40" />
            <span>Profil</span>
        </div>
    </footer>
</div>

@code {
    private string _loggedInUserName = "@MaisM√§drescher";
    private string _animationClass = "";
    private bool _isAnimating = false;
    private int _harvestIndex = 0;
    private HarvestModel? _currentHarvest;

/* Match Variablen */
    private bool _showMatchOverlay = false;
    private HarvestModel? _matchedUser;
    private string[] _confettiColors = { "#FFC107", "#2196F3", "#FF5722", "#4CAF50", "#E91E63" };

    private List<HarvestModel> _harvests = new()
        {
            new() { Username="@MaisMeister", Tag="Mais üåΩ", ImageUrl="pictures/Testbilder/Mais_03.png", ProfileImageUrl="pictures/Profilbilder/Profilbild_07.png", Weight="450 g", Length="22 cm", Width="5 cm", Description="Mein ganzer Stolz aus dem Hochbeet!" }, 
            new() { Username="@GrukenGanove", Tag="Gurken ü•í", ImageUrl="pictures/Testbilder/Gurken_01.jpg", ProfileImageUrl="pictures/Profilbilder/Profilbild_26.png", Weight="300 g", Length="25 cm", Width="6 cm", Description="Knackig und frisch geerntet." }, 
            new() { Username="@K√ºrbisKontrolleur", Tag="K√ºrbis üéÉ", ImageUrl="pictures/Testbilder/K√ºrbisse_01.jpg", ProfileImageUrl="pictures/Profilbilder/Profilbild_12.png", Weight="1200 g", Length="40 cm", Width="45 cm", Description="Fast zu schwer zum Tragen!" }
};

private bool _showLogout = false;
private bool _showAdminNav = false;
private bool _showReportModal = false;
private bool _isProfileVisible = true;
private string _selectedReportReason = "";
private readonly string[] _reportReasons = 
{   "abstossende Inhalte", "sexuelle Inhalte", "gewaltvolle Inhalte", "'Catfishing' - nicht selbst angebaut", "Spam",};

/* Werbe-Logik */
private bool _showAd = true;
private string _currentAdImage = "pictures/ads/pimpyourblechad02.jpg";
private int _adCounter = 0;
private Timer? _adTimer;
private string[] _adImages = new[]
{
"pictures/ads/pimpyourblechad02.jpg",
"pictures/ads/Drachenlord_Schanzenfest_Werbeplakat.jpg",
"pictures/ads/GurkenStandAd.jpg",
"pictures/ads/OBI_werbung.jpg",
"pictures/ads/ralphschuhmacherad.png",
"pictures/ads/werbeplakat-leberkaessemmel.jpg",
"pictures/ads/DieLilaVersuchung.jpg",
"pictures/ads/pimpyourblech01.jpg",
"pictures/ads/werbeplakat-leberkassemmel02.jpg",
"pictures/ads/W√ºrstlStandAd.jpg",
"pictures/ads/pimpyourblechad03.jpg"
};

protected override void OnInitialized()
{
_currentHarvest = _harvests[0];

_currentAdImage = _adImages[0];
_adTimer = new Timer(6000);
_adTimer.Elapsed += async (sender, e) =>
{
_adCounter++;
_currentAdImage = _adImages[_adCounter % _adImages.Length];
await InvokeAsync(StateHasChanged);
};
_adTimer.AutoReset = true;
_adTimer.Enabled = true;
}

private async Task HandleSwipe(bool like)
{
// Task-Logik: Sperre, wenn Animation l√§uft ODER Match-Overlay offen ist
if (_isAnimating || _showMatchOverlay) return;
_isAnimating = true;

_animationClass = like ? "swipe-right" : "swipe-left";
StateHasChanged();

await Task.Delay(600);

// tempor√§re Test-Match-Logik: 30% Chance auf ein Match bei Like
if (like && Random.Shared.Next(1, 101) <= 30)
{
_matchedUser = _currentHarvest;
_showMatchOverlay = true;
await PlayMatchSound();
}

_harvestIndex = (_harvestIndex + 1) % _harvests.Count;
_currentHarvest = _harvests[_harvestIndex];

_animationClass = "fade-in";
StateHasChanged();

await Task.Delay(400);
_animationClass = "";
_isAnimating = false;
}

private async Task PlayMatchSound()
{
// Spielt Konfetti-Sound ab bei Match
await JS.InvokeVoidAsync("eval", "new Audio('sounds/itsamatch.mp3').play()");
}

private void CloseMatchOverlay() => _showMatchOverlay = false;

private async Task CloseAd()
{
_showAd = false;
await Task.Delay(10000);
_showAd = true;
await InvokeAsync(StateHasChanged);
}

public void Dispose() => _adTimer?.Dispose();

private void ToggleLogoutMenu()
{
_showLogout = !_showLogout;
if (!_showLogout) _showAdminNav = false;
}

private void ToggleAdminNav() => _showAdminNav = !_showAdminNav;

private void NavTo(string path)
{
_showLogout = false;
Nav.NavigateTo(path, forceLoad: true);
}

private void NavigateToAboutUs() => Nav.NavigateTo("/ueber-uns", forceLoad: true);
private void NavigateToLogout() => Nav.NavigateTo("/", forceLoad: true);
private void NavigateToPreferences() => Nav.NavigateTo("/pr√§ferenzeinstellungen", forceLoad: true);
private void GoToRanks() => Nav.NavigateTo("/RanglisteTest", forceLoad: true);
private void GoToMatches() => Nav.NavigateTo("/MatchesTest", forceLoad: true);
private void GoToMainpage() => Nav.NavigateTo("/startseite", forceLoad: true);
private void GoToProfile() => Nav.NavigateTo("/ProfilTest", forceLoad: true);
private void FlagProfile() => _showReportModal = true;
private void CloseReportModal() => _showReportModal = false;

private void UpdateReportReason(string reason, ChangeEventArgs e)
{
if ((bool)e.Value) _selectedReportReason = reason;
else if (_selectedReportReason == reason) _selectedReportReason = string.Empty;
}

private void ReportProfile()
{
if (!string.IsNullOrEmpty(_selectedReportReason))
{
_isProfileVisible = false;
_showReportModal = false;
}
}

private string GetUsernameUrl() => _currentHarvest?.Username.TrimStart('@') ?? "";

private class HarvestModel
{
public string Username { get; set; } = "";
public string Tag { get; set; } = "";
public string ImageUrl { get; set; } = "";
public string ProfileImageUrl { get; set; } = "";
public string Weight { get; set; } = "";
public string Length { get; set; } = "";
public string Width { get; set; } = "";
public string Description { get; set; } = "";
}
}