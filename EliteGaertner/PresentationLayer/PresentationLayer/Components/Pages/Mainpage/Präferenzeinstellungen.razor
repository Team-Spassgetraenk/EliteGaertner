@page "/pr√§ferenzeinstellungen"
@using AppLogic.Services
@using Contracts.Data_Transfer_Objects
@using AppLogic.Interfaces
@using PresentationLayer.State
@using PresentationLayer.Shared
@using PresentationLayer.Services

@inject CurrentProfileState CurrentProfile
@inject PreferenceState Preference
@inject IProfileMgm ProfileMgm
@inject SessionService Session

@inject NavigationManager Nav
@inject ILogger<Pr√§ferenzeinstellungen> Logger


<link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">


<div class="page-container background-style">
    <header class="top-bar">
        @* Linke Seite *@
        <div class="icon-wrapper left"
             style="display: flex; align-items: center; gap: 8px; font-weight: bold; font-size: 1.5rem;"
             @onclick="GoBackToProfile">
            <i class="bi bi-chevron-left"></i>
            <span>Zur√ºck</span>
        </div>

        @* Mitte (wird durch CSS absolut zentriert) *@
        <h1 class="page-title">Pr√§ferenzeinstellungen</h1>

        @* Rechte Seite *@
        <div class="header-right-group" style="display: flex; align-items: center; gap: 20px;">
            @if (!string.IsNullOrEmpty(CurrentProfile.UserName))
            {
                <span class="logged-in-user" style="font-weight: bold; font-size: 1.5rem;">
                    üë§ @($"@{CurrentProfile.UserName}")
                </span>
            }
            <div class="menu-icon-container" @onclick="ToggleLogoutMenu">
                <span class="menu-icon">‚ò∞</span>
            </div>
        </div>
    </header>
    
    @if (_showLogout)
    {
        <div class="logout-menu admin-menu-ext">
            <p class="logout-link" @onclick="Session.Logout">Logout ‚ûú]</p>  
            <div class="admin-header" @onclick="NavigateToAboutUs">
                <span>‚ÑπÔ∏è √úber uns</span>
            </div>
        </div>
    }
    
    <div class="login-center">

        <div class="register-card">

            <div class="logo-container">
                <img src="pictures/EliteG√§rtner_logo.png" alt="EliteG√§rtner Logo" class="app-logo"/>
                @* √ºber die CSS-Klasse elitegaertner-title definiert *@
                <h2 class="elitegaertner-title mt-2">EliteG√§rtner.</h2>
            </div>

            <h3 class="register-title">W√§hle deine Interessen</h3>

            <h4 class="tag-headline">Gem√ºse</h4>
            <div class="tag-grid">
                @foreach (var tag in TagCatalog.Gemuese)
                {
                    <div class="tag app-tag @(Preference.CurrentProfileTagIds.Contains(tag.TagId) ? "selected" : "")"
                         @onclick="() => Preference.ToggleTag(tag.TagId)">
                        <span>@tag.Icon</span>
                        <span>@tag.Name</span>
                    </div>
                }
            </div>

            <h4 class="tag-headline">Obst</h4>
            <div class="tag-grid">
                @foreach (var tag in TagCatalog.Obst)
                {
                    <div class="tag app-tag @(Preference.CurrentProfileTagIds.Contains(tag.TagId) ? "selected" : "")"
                         @onclick="() => Preference.ToggleTag(tag.TagId)">
                        <span>@tag.Icon</span>
                        <span>@tag.Name</span>
                    </div>
                }
            </div>

            <button class="app-button primary-button weiter-button"
                    disabled="@(!Preference.CurrentProfileTagIds.Any())"
                    @onclick="Speichern">
                Speichern
            </button>

            @if (!Preference.CurrentProfileTagIds.Any())
            {
                <p class="disabled-hint">Bitte mindestens ein Tag ausw√§hlen.</p>
            }

        </div>

    </div>
</div>

@code {

    // ----------------------------
    // UI State
    // ----------------------------
    private string _loggedInUserName = "";

    private bool _showLogout = false;
    
    protected override void OnInitialized()
    {
        //√úberpr√ºfung
        //Wenn kein Profil im CurrentProfileState -> zur√ºck zur Startseite
        if (CurrentProfile.LoggedInProfile is null)
        {
            Logger.LogWarning("Preferences page opened without logged-in profile. Redirecting to /");
            Nav.NavigateTo("/");
            return;
        }

        Logger.LogInformation(
            "Preferences page initialized for ProfileId {ProfileId}. Existing preference count: {Count}",
            CurrentProfile.ProfileId,
            CurrentProfile.PreferenceDtos?.Count ?? 0
        );

        CurrentProfile.Onchange += StateHasChanged;

        //Initialisiert die TagId Liste in PreferenceState
        //Falls PreferenceDto is null -> Leere Liste √ºbergeben
        Preference.InitializeCurrentProfileTagIds(CurrentProfile.PreferenceDtos ?? Array.Empty<PreferenceDto>());

        Logger.LogDebug(
            "PreferenceState initialized with {SelectedCount} selected tags for ProfileId {ProfileId}",
            Preference.CurrentProfileTagIds.Count,
            CurrentProfile.ProfileId
        );
    }
    
    void Speichern()
    {
        //√úberpr√ºft ob ProfileId null ist
        if (CurrentProfile.ProfileId is null)
        {
            Logger.LogWarning("Preferences save attempted but ProfileId is null. Redirecting to /");
            //Falls ja, Zur√ºck zur Login Seite 
            Nav.NavigateTo("/");
            return;
        }

        var profileId = CurrentProfile.ProfileId.Value;
        var selectedTagIds = Preference.CurrentProfileTagIds.OrderBy(x => x).ToArray();

        Logger.LogInformation(
            "Saving preferences for ProfileId {ProfileId}. SelectedTagCount={Count}. SelectedTagIds={TagIds}",
            profileId,
            selectedTagIds.Length,
            selectedTagIds
        );

        try
        {
            //Speichern der neuen Preferences
            ProfileMgm.SetPreference(
                //Die Preference HashSet muss erstmal wieder in DTOS gepackt werden
                Preference.CreatePreferenceDtos(profileId)
            );

            Logger.LogInformation("Preferences saved successfully for ProfileId {ProfileId}. Refreshing profile...", profileId);

            CurrentProfile.RefreshProfile(ProfileMgm);

            Logger.LogInformation(
                "Profile refreshed after preference save for ProfileId {ProfileId}. Navigating to /startseite",
                profileId
            );

            Dispose();
            
            //Zur√ºck zu Startseite
            Nav.NavigateTo("/startseite");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error while saving preferences for ProfileId {ProfileId}", profileId);
        }
    }
    
    private void Dispose()
    {
        CurrentProfile.Onchange -= StateHasChanged;
    }
    
    //Aktionen
    private void ToggleLogoutMenu()
    {
        _showLogout = !_showLogout;
        Logger.LogDebug("Pr√§ferenzeinstellungen: ToggleLogoutMenu -> ShowLogout={ShowLogout}.", _showLogout);
    }

    //Navigation
    private void GoBackToProfile()
    {
        Logger.LogInformation("Pr√§ferenzeinstellungen: Navigation -> Startseite.");
        Nav.NavigateTo("/startseite");
    }
    
    private void NavigateToAboutUs()
    {
        Logger.LogInformation("Pr√§ferenzeinstellungen: Navigation -> Ueber-Uns.");
        Nav.NavigateTo("/ueber-uns");
    }
}