@page "/präferenzeinstellungen"
@using AppLogic.Services
@using Contracts.Data_Transfer_Objects
@using AppLogic.Interfaces
@using PresentationLayer.State
@using PresentationLayer.Shared
@inject CurrentProfileState CurrentProfile
@inject PreferenceState Preference
@inject IProfileMgm ProfileMgm

@inject NavigationManager Nav
@inject ILogger<Präferenzeinstellungen> Logger


<link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600&display=swap" rel="stylesheet">

<div class="register-page-container">
    <div class="login-center">

        <div class="register-card">

            <div class="logo-container">
                <img src="pictures/EliteGärtner_logo.png" alt="EliteGärtner Logo" class="app-logo" />
                @* über die CSS-Klasse elitegaertner-title definiert *@
                <h2 class="elitegaertner-title mt-2">EliteGärtner.</h2>
            </div>
            
            <h3 class="register-title">Präferenzeinstellungen</h3>
            
            <h4 class="tag-headline">Gemüse</h4>
            <div class="tag-grid">
                @foreach (var tag in TagCatalog.Gemuese)
                {
                    <div class="tag app-tag @(Preference.CurrentProfileTagIds.Contains(tag.TagId) ? "selected" : "")"
                         @onclick="() => Preference.ToggleTag(tag.TagId)">
                        <span>@tag.Icon</span>
                        <span>@tag.Name</span>
                    </div>
                }
            </div>

            <h4 class="tag-headline">Obst</h4>
            <div class="tag-grid">
                @foreach (var tag in TagCatalog.Obst)
                {
                    <div class="tag app-tag @(Preference.CurrentProfileTagIds.Contains(tag.TagId) ? "selected" : "")"
                         @onclick="() => Preference.ToggleTag(tag.TagId)">
                        <span>@tag.Icon</span>
                        <span>@tag.Name</span>
                    </div>
                }
            </div>

            <button class="app-button primary-button weiter-button"
                    disabled="@( !Preference.CurrentProfileTagIds.Any() )"
                    @onclick="Speichern">
                Speichern
            </button>
            
            @if ( !Preference.CurrentProfileTagIds.Any() )
            {
                <p class="disabled-hint">Bitte mindestens ein Tag auswählen.</p>
            }

        </div>

    </div>
</div>

@code {
    
    protected override void OnInitialized()
    {
        //Überprüfung
        //Wenn kein Profil im CurrentProfileState -> zurück zur Startseite
        if (CurrentProfile.LoggedInProfile is null)
        {
            Logger.LogWarning("Preferences page opened without logged-in profile. Redirecting to /");
            Nav.NavigateTo("/");
            return;
        }

        Logger.LogInformation(
            "Preferences page initialized for ProfileId {ProfileId}. Existing preference count: {Count}",
            CurrentProfile.ProfileId,
            CurrentProfile.PreferenceDtos?.Count ?? 0
        );

        CurrentProfile.Onchange += StateHasChanged;

        //Initialisiert die TagId Liste in PreferenceState
        //Falls PreferenceDto is null -> Leere Liste übergeben
        Preference.InitializeCurrentProfileTagIds(CurrentProfile.PreferenceDtos ?? Array.Empty<PreferenceDto>());

        Logger.LogDebug(
            "PreferenceState initialized with {SelectedCount} selected tags for ProfileId {ProfileId}",
            Preference.CurrentProfileTagIds.Count,
            CurrentProfile.ProfileId
        );
    }
    
    void Speichern()
    {
        //Überprüft ob ProfileId null ist
        if (CurrentProfile.ProfileId is null)
        {
            Logger.LogWarning("Preferences save attempted but ProfileId is null. Redirecting to /");
            //Falls ja, Zurück zur Login Seite 
            Nav.NavigateTo("/");
            return;
        }

        var profileId = CurrentProfile.ProfileId.Value;
        var selectedTagIds = Preference.CurrentProfileTagIds.OrderBy(x => x).ToArray();

        Logger.LogInformation(
            "Saving preferences for ProfileId {ProfileId}. SelectedTagCount={Count}. SelectedTagIds={TagIds}",
            profileId,
            selectedTagIds.Length,
            selectedTagIds
        );

        try
        {
            //Speichern der neuen Preferences
            ProfileMgm.SetPreference(
                //Die Preference HashSet muss erstmal wieder in DTOS gepackt werden
                Preference.CreatePreferenceDtos(profileId)
            );

            Logger.LogInformation("Preferences saved successfully for ProfileId {ProfileId}. Refreshing profile...", profileId);

            CurrentProfile.RefreshProfile(ProfileMgm);

            Logger.LogInformation(
                "Profile refreshed after preference save for ProfileId {ProfileId}. Navigating to /startseite",
                profileId
            );

            Dispose();
            
            //Zurück zu Startseite
            Nav.NavigateTo("/startseite");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error while saving preferences for ProfileId {ProfileId}", profileId);
        }
    }
    
    private void Dispose()
    {
        CurrentProfile.Onchange -= StateHasChanged;
    }
}