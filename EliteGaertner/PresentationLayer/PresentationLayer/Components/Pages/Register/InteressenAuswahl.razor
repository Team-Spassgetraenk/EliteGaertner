@page "/registrierung/interessen"

@layout Layout.MainLayout

@using PresentationLayer.State
@using PresentationLayer.Shared
@using AppLogic.Interfaces

@inject IProfileMgm ProfileMgm
@inject UserRegistrationState RegistrationState
@inject NavigationManager Nav


@* WICHTIG: Beide Schriftarten laden, da Patrick Hand für den allgemeinen Text und Playfair Display für den EliteGärtner-Titel verwendet wird *@
<link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600&display=swap" rel="stylesheet">

<div class="register-page-container">
    <div class="login-center">

        <div class="register-card">

            <div class="logo-container">
                <img src="pictures/EliteGärtner_logo.png" alt="EliteGärtner Logo" class="app-logo" />
                @* Style entfernt und über die CSS-Klasse elitegaertner-title definiert *@
                <h2 class="elitegaertner-title mt-2">EliteGärtner.</h2>
            </div>
            
            <h3 class="register-title">Wähle dein Interessensprofil</h3>
            
            <h4 class="tag-headline">Gemüse</h4>
            <div class="tag-grid">
                @foreach (var tag in TagCatalog.Gemuese)
                {
                    <div class="tag app-tag @(RegistrationState.SelectedTags.Contains(tag.Name) ? "selected" : "")"
                         @onclick="() => ToggleTag(tag.Name)">
                        <span>@tag.Icon</span>
                        <span>@tag.Name</span>
                    </div>
                }
            </div>

            <h4 class="tag-headline">Obst</h4>
            <div class="tag-grid">
                @foreach (var tag in TagCatalog.Obst)
                {
                    <div class="tag app-tag @(RegistrationState.SelectedTags.Contains(tag.Name) ? "selected" : "")"
                         @onclick="() => ToggleTag(tag.Name)">
                        <span>@tag.Icon</span>
                        <span>@tag.Name</span>
                    </div>
                }
            </div>

            <button class="app-button primary-button weiter-button"
                    disabled="@( !RegistrationState.SelectedTags.Any() )"
                    @onclick="Speichern">
                Speichern
            </button>
            
            @if ( !RegistrationState.SelectedTags.Any() )
            {
                <p class="disabled-hint">Bitte mindestens ein Tag auswählen.</p>
            }

        </div>

    </div>
</div>

@code {
    void ToggleTag(string tag)
    {
        if (RegistrationState.SelectedTags.Contains(tag))
        {
            RegistrationState.SelectedTags.Remove(tag);
        }
        else
        {RegistrationState.SelectedTags.Add(tag);}
        StateHasChanged();
    }

    void Speichern()
    {
        if (RegistrationState.ProfileId == 0) //Überprüfung: Ist neues Profil angelegt? 
        {
            Nav.NavigateTo("/registrierung");
            return;
        }

        var preferences = RegistrationState.SelectedTags
            .Select(tagName => TagCatalog.FindByName(tagName))
            .Select(tag => new PreferenceDto 
            { 
                TagId = tag.TagId, 
                Profileid = RegistrationState.ProfileId,
                DateUpdated = DateTime.UtcNow 
            }).ToList();

        bool success = ProfileMgm.SetPreference(preferences);
    
        if (success)
        {
            Console.WriteLine($"Tags für ProfileId {RegistrationState.ProfileId} gespeichert");
            Nav.NavigateTo("/registrierung/profilerstellung");
        }
        else
        {
            Console.WriteLine("Fehler beim Speichern der Tags.");
        }
    }
}