@page "/registrierung/interessen"
@using Contracts.Data_Transfer_Objects
@using AppLogic.Interfaces
@inject IProfileMgm ProfileMgm
@using PresentationLayer.State
@inject UserRegistrationState RegistrationState
@inject NavigationManager Nav
@rendermode InteractiveServer

@* WICHTIG: Beide Schriftarten laden, da Patrick Hand fÃ¼r den allgemeinen Text und Playfair Display fÃ¼r den EliteGÃ¤rtner-Titel verwendet wird *@
<link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600&display=swap" rel="stylesheet">

<div class="register-page-container">
    <div class="login-center">

        <div class="register-card">

            <div class="logo-container">
                <img src="pictures/EliteGÃ¤rtner_logo.png" alt="EliteGÃ¤rtner Logo" class="app-logo" />
                @* Style entfernt und Ã¼ber die CSS-Klasse elitegaertner-title definiert *@
                <h2 class="elitegaertner-title mt-2">EliteGÃ¤rtner.</h2>
            </div>
            
            <h3 class="register-title">WÃ¤hle dein Interessensprofil</h3>
            
            <h4 class="tag-headline">GemÃ¼se</h4>
            <div class="tag-grid">
                @foreach (var tag in _gemueseTags)
                {
                    <div class="tag app-tag @(RegistrationState.SelectedTags.Contains(tag.Name) ? "selected" : "")"
                         @onclick="() => ToggleTag(tag.Name)">
                        <span>@tag.Icon</span>
                        <span>@tag.Name</span>
                    </div>
                }
            </div>

            <h4 class="tag-headline">Obst</h4>
            <div class="tag-grid">
                @foreach (var tag in _obstTags)
                {
                    <div class="tag app-tag @(RegistrationState.SelectedTags.Contains(tag.Name) ? "selected" : "")"
                         @onclick="() => ToggleTag(tag.Name)">
                        <span>@tag.Icon</span>
                        <span>@tag.Name</span>
                    </div>
                }
            </div>

            <button class="app-button primary-button weiter-button"
                    disabled="@( !RegistrationState.SelectedTags.Any() )"
                    @onclick="Speichern">
                Speichern
            </button>
            
            @if ( !RegistrationState.SelectedTags.Any() )
            {
                <p class="disabled-hint">Bitte mindestens ein Tag auswÃ¤hlen.</p>
            }

        </div>

    </div>
</div>

@code {
    public record TagItem(int TagId, string Name, string Icon);

    List<TagItem> _gemueseTags = new()
    {
        new(1, "Auberginen", "ğŸ†"),
        new(2, "Gurken", "ğŸ¥’"),
        new(3, "Tomaten", "ğŸ…"),
        new(4, "KÃ¼rbisse", "ğŸƒ"),
        new(5, "Paprika", "ğŸŒ¶ï¸"),
        new(6, "Zucchini", "ğŸ¥’"),
        new(7, "Kartoffeln", "ğŸ¥”"),
        new(8, "Karotten", "ğŸ¥•"),
        new(9, "Salate", "ğŸ¥¬"),
        new(10, "Zwiebeln", "ğŸ§…"),
        new(18, "Bohnen", "ğŸŒ¿"),
        new(19, "Spinat", "ğŸƒ"),
        new(20, "Radieschen", "ğŸŒ±"),
        new(21, "Brokkoli", "ğŸ¥¦"),
        new(22, "Mais", "ğŸŒ½"),
    };

    List<TagItem> _obstTags = new()
    {
        new(11, "Melonen", "ğŸ‰"),
        new(12, "Ã„pfel", "ğŸ"),
        new(13, "Birnen", "ğŸ"),
        new(14, "Pfirsiche", "ğŸ‘"),
        new(15, "Kirschen", "ğŸ’"),
        new(16, "Erdbeeren", "ğŸ“"),
        new(17, "Trauben", "ğŸ‡")
    };
    
    void ToggleTag(string tag)
    {
        if (RegistrationState.SelectedTags.Contains(tag))
        {
            RegistrationState.SelectedTags.Remove(tag);
        }
        else
        {RegistrationState.SelectedTags.Add(tag);}
        StateHasChanged();
    }

    void Speichern()
    {
        if (RegistrationState.ProfileId == 0) //ÃœberprÃ¼fung: Ist neues Profil angelegt? 
        {
            Nav.NavigateTo("/registrierung");
            return;
        }
        
        var allTags = _gemueseTags.Concat(_obstTags).ToList();

        var preferences = RegistrationState.SelectedTags
            .Select(tagName => allTags.First(t => t.Name == tagName))
            .Select(tag => new PreferenceDto 
            { 
                TagId = tag.TagId, 
                Profileid = RegistrationState.ProfileId,
                DateUpdated = DateTime.UtcNow 
            }).ToList();

        bool success = ProfileMgm.SetPreference(preferences);
    
        if (success)
        {
            Console.WriteLine($"Tags fÃ¼r ProfileId {RegistrationState.ProfileId} gespeichert");
            Nav.NavigateTo("/registrierung/profilerstellung", forceLoad: true);
        }
        else
        {
            Console.WriteLine("Fehler beim Speichern der Tags.");
        }
    }
}