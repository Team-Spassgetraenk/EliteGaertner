@page "/registrierung"
@rendermode InteractiveServer
@inject NavigationManager Nav
@inject UserRegistrationState RegistrationState
@using System.Text.RegularExpressions
@using Microsoft.AspNetCore.Components

<link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&display=swap" rel="stylesheet">

<div class="register-page-container">
    <div class="login-center">

        <div class="register-card">

            <div class="logo-container">
                <img src="pictures/EliteG√§rtner_logo.png" alt="EliteG√§rtner Logo" class="app-logo" />
                <h2 class="elitegaertner-title mt-2" style="font-weight: 600; font-size: 2.5rem;">EliteG√§rtner.</h2>
            </div>

            <h3 class="register-title">Neuen Account erstellen</h3>

            <div class="two-column-grid">

                <div class="input-column">
                    <div class="input-group">
                        <label for="sirname-input">Nachname</label>
                        <input id="sirname-input" class="app-input" placeholder="Nachname eingeben" @bind="_sirname" @bind:event="oninput" />
                    </div>

                    <div class="input-group">
                        <label for="prename-input">Vorname</label>
                        <input id="prename-input" class="app-input" placeholder="Vorname eingeben" @bind="_prename" @bind:event="oninput" />
                    </div>

                    <div class="input-group">
                        <label for="username-input">Benutzername</label>
                        <input id="username-input" class="app-input" placeholder="Benutzername eingeben" @bind="_username" @bind:event="oninput" />
                    </div>

                    <div class="input-group">
                        <label for="telephone-input">Telefonnummer</label>

                        <div class="phone-input-container">
                            <select class="country-code-select" @bind="SelectedCountryCode" @bind:event="onchange">
                                @foreach (var country in _countryCodes)
                                {
                                <option value="@country.Code">
                                    @country.Flag @country.Code
                                </option>
                                }
                            </select>

                            <input id="telephone-input"
                                   class="app-input phone-number-input"
                                   placeholder="‚úÜ"
                                   type="text"
                                   @bind="TelephoneNumberLocal"
                                   @bind:event="oninput" />
                        </div>
                    </div>

                    <div class="input-group mb-0"> @* mb-0 am letzten Element der linken Spalte ist gut f√ºr die Optik *@
                        <label for="email-input">Email</label>
                        <input id="email-input"
                               class="app-input @(!string.IsNullOrWhiteSpace(_email) && !EmailValid ? "input-error" : "")"
                               placeholder="Email eingeben"
                               @bind="_email" @bind:event="oninput"/>

                        @if (!string.IsNullOrWhiteSpace(_email) && !EmailValid)
                        {
                        <p class="inline-error error-text">‚ö†Ô∏è Die eingegebene Email-Adresse ist ung√ºltig.</p>
                        }
                    </div>

                </div>

                <div class="input-column">

                    <div class="password-section">

                        <div class="input-group">
                            <label for="password-input">Passwort</label>
                            <input id="password-input"
                                   class="app-input @(!IsPasswordStrong && !string.IsNullOrWhiteSpace(_password) ? "input-error" : "")"
                                   type="password"
                                   placeholder="Passwort eingeben"
                                   @bind="_password" @bind:event="oninput"/>

                            <div class="password-requirements mt-2">
                                <h5 class="req-title">Passwortanforderungen:</h5>
                                <ul>
                                    <li class="@(HasMinimumLength ? "passed" : "")">
                                        @GetRequirementIcon(HasMinimumLength) Mindestens 8 Zeichen L√§nge.
                                    </li>
                                    <li class="@(HasUppercase ? "passed" : "")">
                                        @GetRequirementIcon(HasUppercase) Mindestens einen Gro√übuchstaben.
                                    </li>
                                    <li class="@(HasLowercase ? "passed" : "")">
                                        @GetRequirementIcon(HasLowercase) Mindestens einen Kleinbuchstaben.
                                    </li>
                                    <li class="@(HasDigit ? "passed" : "")">
                                        @GetRequirementIcon(HasDigit) Mindestens eine Ziffer (0-9).
                                    </li>
                                    <li class="@(HasSpecialChar ? "passed" : "")">
                                        @GetRequirementIcon(HasSpecialChar) Mindestens ein Sonderzeichen (@GetSpecialChars()).
                                    </li>
                                </ul>
                            </div>
                        </div>

                        <div class="input-group mb-0"> @* mb-0 am letzten Element in der Sektion *@
                            <label for="password-confirm-input">Passwort best√§tigen</label>
                            <input id="password-confirm-input"
                                   class="app-input @(PasswordMismatch ? "input-error" : "")"
                                   type="password"
                                   placeholder="Passwort wiederholen"
                                   @bind="_passwordConfirm" @bind:event="oninput" />

                            @if (PasswordMismatch)
                            {
                            <p class="inline-error error-text">‚ö†Ô∏è Die Passw√∂rter stimmen nicht √ºberein.</p>
                            }
                        </div>
                    </div>
                </div>
            </div>

            <div class="contact-share-section mt-4">
                <h4 class="share-title">Kontaktdaten freigeben</h4>
                <p class="share-description">W√§hle, welche Kontaktdaten du mit gematchten G√§rtnern teilen m√∂chtest.</p>

                <div class="share-options-grid">
                    <div class="form-check-group">
                        <div class="form-check-custom">
                            <input class="app-check-input" type="checkbox" id="shareEmail" @bind="_shareEmail" @bind:event="onchange" />
                            <label class="app-check-label" for="shareEmail">
                                Email
                            </label>
                        </div>
                    </div>

                    <div class="form-check-group">
                        <div class="form-check-custom">
                            <input class="app-check-input" type="checkbox" id="shareTel" @bind="_shareTelephone" @bind:event="onchange" />
                            <label class="app-check-label" for="shareTel">
                                Telefonnummer
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <button class="app-button primary-button mt-4"
                    @onclick="Registrieren"
                    disabled="@(!RegisterEnabled)">
                Registrieren
            </button>

            @if (!RegisterEnabled)
            {
            <p class="disabled-hint">
                @(
                (
                !RequiredFieldsFilled
                ? "Bitte alle Registrierungsfelder ausf√ºllen."
                : (PasswordMismatch
                ? "‚ö†Ô∏è Die Passw√∂rter stimmen nicht √ºberein."
                : (!IsPasswordStrong
                ? "‚ö†Ô∏è Das Passwort erf√ºllt nicht alle Sicherheitsanforderungen."
                : (!ContactShareSelected
                ? "Bitte mindestens eine Kontaktmethode zur Freigabe ausw√§hlen."
                : ""
                )
                )
                )
                )
                )
            </p>
            }

            <div class="register-text">
                <p>Ich habe bereits einen Account?</p>
                <a href="/" class="register-link">Jetzt Anmelden</a>
            </div>

        </div>
    </div>
</div>

@code {

// Modell f√ºr die L√§ndervorwahlen
public class CountryCode
{
public string Name { get; set; }
public string Code { get; set; }
public string Flag { get; set; }
}

// Eingabefeld-Variablen (Data Binding)
string _sirname = "";
string _prename = "";
string _email = "";
string _username = "";
string _password = "";
string _passwordConfirm = "";

public string SelectedCountryCode { get; set; } = "+49";

// KORREKTUR: Property f√ºr Telefonnummer mit eingebauter Filterlogik
private string _telephoneNumberLocal = "";
public string TelephoneNumberLocal
{
get => _telephoneNumberLocal;
set
{
if (!string.IsNullOrWhiteSpace(value))
{
// Regex: Entferne alle Zeichen, die KEINE Ziffer (\D) sind.
_telephoneNumberLocal = Regex.Replace(value, @"\D", "");
}
else
{
_telephoneNumberLocal = "";
}
}
}

// Checkbox-Zust√§nde der Freigabe-Optionen
bool _shareEmail = false;
bool _shareTelephone = false;

// Liste der L√§ndercodes
private List<CountryCode> _countryCodes = new List<CountryCode>
{
new CountryCode { Name = "Deutschland", Code = "+49", Flag = "üá©üá™" },
new CountryCode { Name = "√ñsterreich", Code = "+43", Flag = "üá¶üáπ" },
new CountryCode { Name = "Schweiz", Code = "+41", Flag = "üá®üá≠" },
new CountryCode { Name = "Vereinigtes K√∂nigreich", Code = "+44", Flag = "üá¨üáß" },
new CountryCode { Name = "Vereinigte Staaten (USA)", Code = "+1", Flag = "üá∫üá∏" },
new CountryCode { Name = "Kanada", Code = "+1", Flag = "üá®üá¶" },
new CountryCode { Name = "Belgien", Code = "+32", Flag = "üáßüá™" },
new CountryCode { Name = "Bulgarien", Code = "+359", Flag = "üáßüá¨" },
new CountryCode { Name = "D√§nemark", Code = "+45", Flag = "üá©üá∞" },
new CountryCode { Name = "Estland", Code = "+372", Flag = "üá™üá™" },
new CountryCode { Name = "Finnland", Code = "+358", Flag = "üá´üáÆ" },
new CountryCode { Name = "Frankreich", Code = "+33", Flag = "üá´üá∑" },
new CountryCode { Name = "Griechenland", Code = "+30", Flag = "üá¨üá∑" },
new CountryCode { Name = "Irland", Code = "+353", Flag = "üáÆüá™" },
new CountryCode { Name = "Italien", Code = "+39", Flag = "üáÆüáπ" },
new CountryCode { Name = "Kroatien", Code = "+385", Flag = "üá≠üá∑" },
new CountryCode { Name = "Lettland", Code = "+371", Flag = "üá±üáª" },
new CountryCode { Name = "Litauen", Code = "+370", Flag = "üá±üáπ" },
new CountryCode { Name = "Luxemburg", Code = "+352", Flag = "üá±üá∫" },
new CountryCode { Name = "Malta", Code = "+356", Flag = "üá≤üáπ" },
new CountryCode { Name = "Niederlande", Code = "+31", Flag = "üá≥üá±" },
new CountryCode { Name = "Polen", Code = "+48", Flag = "üáµüá±" },
new CountryCode { Name = "Portugal", Code = "+351", Flag = "üáµüáπ" },
new CountryCode { Name = "Rum√§nien", Code = "+40", Flag = "üá∑üá¥" },
new CountryCode { Name = "Schweden", Code = "+46", Flag = "üá∏üá™" },
new CountryCode { Name = "Slowakei", Code = "+421", Flag = "üá∏üá∞" },
new CountryCode { Name = "Slowenien", Code = "+386", Flag = "üá∏üáÆ" },
new CountryCode { Name = "Spanien", Code = "+34", Flag = "üá™üá∏" },
new CountryCode { Name = "Tschechien", Code = "+420", Flag = "üá®üáø" },
new CountryCode { Name = "Ungarn", Code = "+36", Flag = "üá≠üá∫" },
new CountryCode { Name = "Zypern", Code = "+357", Flag = "üá®üáæ" },
new CountryCode { Name = "Andorra", Code = "+376", Flag = "üá¶üá©" },
new CountryCode { Name = "Island", Code = "+354", Flag = "üáÆüá∏" },
new CountryCode { Name = "Norwegen", Code = "+47", Flag = "üá≥üá¥" },
new CountryCode { Name = "T√ºrkei", Code = "+90", Flag = "üáπüá∑" },
new CountryCode { Name = "Australien", Code = "+61", Flag = "üá¶üá∫" },
new CountryCode { Name = "Neuseeland", Code = "+64", Flag = "üá≥üáø" },
new CountryCode { Name = "Japan", Code = "+81", Flag = "üáØüáµ" },
new CountryCode { Name = "China", Code = "+86", Flag = "üá®üá≥" },
new CountryCode { Name = "Mexiko", Code = "+52", Flag = "üá≤üáΩ" },
new CountryCode { Name = "Brasilien", Code = "+55", Flag = "üáßüá∑" },
};

// Public Property zur Speicherung in der Datenbank (Zusammengesetzte Nummer)
public string FullTelephoneNumber =>
$"{SelectedCountryCode.Replace("+", "")}{TelephoneNumberLocal}";


// ======================================
// 1. PASSWORD VALIDIERUNG 
// ======================================

private bool HasMinimumLength => _password.Length >= 8;
private bool HasUppercase => Regex.IsMatch(_password, @"[A-Z]");
private bool HasLowercase => Regex.IsMatch(_password, @"[a-z]");
private bool HasDigit => Regex.IsMatch(_password, @"[0-9]");
private bool HasSpecialChar => Regex.IsMatch(_password, @"[#?!@$%^&*-]");
private bool IsPasswordStrong =>
HasMinimumLength && HasUppercase && HasLowercase && HasDigit && HasSpecialChar;
private MarkupString GetRequirementIcon(bool passed) =>
passed ? (MarkupString)"<span class=\"check-icon\">‚úî</span>" : (MarkupString)"<span class=\"fail-icon\">‚úó</span>";
private string GetSpecialChars() => "#?!@$%^&*-";


// ======================================
// 2. GESAMT VALIDIERUNG
// ======================================

private bool PasswordMismatch =>
!string.IsNullOrWhiteSpace(_password) && !string.IsNullOrWhiteSpace(_passwordConfirm) && (_password != _passwordConfirm);
private bool EmailValid => string.IsNullOrWhiteSpace(_email) || IsValidEmail(_email);
private bool IsTelephoneNumberValid => !string.IsNullOrWhiteSpace(TelephoneNumberLocal);
private bool RequiredFieldsFilled =>
!string.IsNullOrWhiteSpace(_sirname) && !string.IsNullOrWhiteSpace(_prename) &&
!string.IsNullOrWhiteSpace(_email) && !string.IsNullOrWhiteSpace(_username) &&
IsTelephoneNumberValid && !string.IsNullOrWhiteSpace(_password) && !string.IsNullOrWhiteSpace(_passwordConfirm);
private bool ContactShareSelected => _shareEmail || _shareTelephone;
private bool RegisterEnabled =>
RequiredFieldsFilled && !PasswordMismatch && ContactShareSelected && EmailValid && IsPasswordStrong;

// Methode: Registrierung und Weiterleitung
void Registrieren()
{
if (RegisterEnabled)
{
Console.WriteLine($"Registrierung erfolgreich f√ºr: {_email}");
Console.WriteLine($"Volle Telefonnummer zur Speicherung: {FullTelephoneNumber}");
Nav.NavigateTo("/registrierung/interessen", forceLoad: true);
}
}

// Statische Methode: Email-Validierung (Regex)
public static bool IsValidEmail(string email)
{
if (string.IsNullOrWhiteSpace(email))
return true;
string pattern = @"^(?!\.)(""([^""\r\\]|\\[""\r\\])*""|" + @"([-a-z0-9!#$%&'*+/=?^_`{|}~]|(?<!\.)\.)*)(?<!\.)" + @"@[a-z0-9][\w\.-]*[a-z0-9]\.[a-z][a-z\.]*[a-z]$";
try
{
var regex = new Regex(pattern, RegexOptions.IgnoreCase, TimeSpan.FromMilliseconds(250));
return regex.IsMatch(email);
}
catch (RegexParseException)
{
return false;
}
catch (RegexMatchTimeoutException)
{
return false;
}
}
}