@page "/registrierung/profilerstellung"

@layout Layout.MainLayout

@using AppLogic.Interfaces
@using PresentationLayer.State

@inject UserRegistrationState RegistrationState
@inject NavigationManager Nav
@inject NavigationManager NavigationManager
@inject IProfileMgm ProfileMgm

<link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

<div class="register-page-container">
    <div class="login-center">

        <div class="register-card profil-card">

            <div class="logo-container">
                @* HIER KEINE ÄNDERUNG, da die Aubergine NICHT im Unterordner Profilbilder liegt *@
                <img src="pictures/EliteGärtner_logo.png" alt="EliteGärtner Logo" class="app-logo-large" />
                <h2 class="elitegaertner-title-large">EliteGärtner.</h2>
            </div>

            <h3 class="register-title-comic">Erstelle dein Gärtnerprofil</h3>
            
            <div class="form-layout">
                
                <h4 class="tag-headline">Wähle dein Profilbild</h4>
                
                <div class="profile-carousel-hybrid">
                    
                    @* Pfeil Links *@
                    <button class="arrow-nav-button secondary-button" 
                            @onclick="SelectPreviousProfile">
                        <i class="bi bi-caret-left-fill"></i>
                    </button>

                    @* Vorschau Links (Vorgänger-Bild)*@
                    <div class="profile-preview-container-hybrid">
                        <img src="@($"pictures/Profilbilder/{GetProfileName(CurrentIndex - 1)}")" 
                             alt="Vorschau" 
                             class="profile-image-preview" />
                    </div>

                    @* Zentrales, ausgewähltes Bild*@
                    <div class="profile-main-image-container-hybrid selected-outline-hybrid">
                        <img src="@($"pictures/Profilbilder/{SelectedProfile}")" 
                             alt="Aktuelles Profilbild" 
                             class="profile-image-large" />
                    </div>
                    
                    @* Vorschau Rechts (Nachfolger-Bild)*@
                    <div class="profile-preview-container-hybrid">
                        <img src="@($"pictures/Profilbilder/{GetProfileName(CurrentIndex + 1)}")" 
                             alt="Vorschau" 
                             class="profile-image-preview" />
                    </div>
                    
                    @* Pfeil Rechts *@
                    <button class="arrow-nav-button secondary-button" 
                            @onclick="SelectNextProfile">
                        <i class="bi bi-caret-right-fill"></i>
                    </button>
                    
                </div>

                <div class="input-group">
                    <label class="input-label">Profilbeschreibung</label>
                    <textarea class="app-input-comic" @bind="Bio" placeholder="Erzähle kurz, wer du bist und was du anbaust..." maxlength="150"></textarea>
                    <div class="char-counter">@Bio.Length / 150</div>
                </div>

                <button class="app-button primary-button weiter-button"
                        @onclick="Weiter" 
                        disabled="@(!IsFormValid)">
                    Weiter zur Ernte
                </button>
                
                @if (!IsFormValid)
                {
                    <p class="disabled-hint">Bitte wähle zuerst ein Profilbild und füge eine Beschreibung hinzu.</p>
                }
            </div>
        </div>
    </div>
</div>

@code {
    private string Bio { get; set; } = "";
    
    // Alle verfügbaren Profilbilder
    private List<string> _availableProfiles = new()
    {
        "Profilbild_01.png", "Profilbild_02.png", "Profilbild_03.png", "Profilbild_04.png", 
        "Profilbild_05.png", "Profilbild_06.png", "Profilbild_07.png", "Profilbild_08.png", 
        "Profilbild_09.png", "Profilbild_10.png", "Profilbild_11.png", "Profilbild_12.png", 
        "Profilbild_13.png", "Profilbild_14.png", "Profilbild_15.png", "Profilbild_16.png", 
        "Profilbild_17.png", "Profilbild_18.png", "Profilbild_19.png", "Profilbild_20.png",
        "Profilbild_21.png", "Profilbild_22.png", "Profilbild_23.png", "Profilbild_24.png",
        "Profilbild_25.png", "Profilbild_26.png", "Profilbild_27.png", "Profilbild_28.png"
    };

    private string SelectedProfile { get; set; }
    
    private int CurrentIndex { get; set; }
    
    protected override void OnInitialized()
    {
        CurrentIndex = 0;
        SelectedProfile = _availableProfiles[CurrentIndex];
    }

    private bool IsFormValid => !string.IsNullOrWhiteSpace(Bio) && !string.IsNullOrWhiteSpace(SelectedProfile);

    private string GetProfileName(int index)
    {
        int effectiveIndex = (index % _availableProfiles.Count + _availableProfiles.Count) % _availableProfiles.Count;
        return _availableProfiles[effectiveIndex];
    }
    
    private void SelectNextProfile()
    {
        CurrentIndex = (CurrentIndex + 1) % _availableProfiles.Count;
        SelectedProfile = _availableProfiles[CurrentIndex];
    }
    
    private void SelectPreviousProfile()
    {
        CurrentIndex = (CurrentIndex - 1 + _availableProfiles.Count) % _availableProfiles.Count;
        SelectedProfile = _availableProfiles[CurrentIndex];
    }
    
    private void Weiter()
    {
        if (RegistrationState.ProfileId == 0) //Überprüfung: Ist neues Profil angelegt? 
        {
            Nav.NavigateTo("/registrierung");
            return;
        }
        
        var profile = ProfileMgm.GetPrivProfile(RegistrationState.ProfileId);
        var updatedProfile = profile with 
        { 
            ProfilepictureUrl = SelectedProfile,
            Profiletext = Bio
    };

        if (ProfileMgm.UpdateProfile(updatedProfile))
        {
            Console.WriteLine($"Profilbild und Bio für ProfileId {RegistrationState.ProfileId} gespeichert");
            Nav.NavigateTo("/registrierung/ernte-hochladen");
        }
        else
        {
            Console.WriteLine("Fehler beim Speichern von Bio.");
        }
        
        
    }
}
