@page "/profil/profilverwaltung"
@using System.Text.RegularExpressions
@using System.ComponentModel.DataAnnotations
@using System.IO
@using AppLogic.Interfaces
@using PresentationLayer.Services
@using PresentationLayer.State
@using PresentationLayer.Shared

@inject IProfileMgm ProfileMgm
@inject CurrentProfileState CurrentProfile
@inject SessionService Session
@inject NavigationManager Nav


<link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

<div class="page-container background-style">

    @* --- TOP BAR: Titel und Menü --- *@
    <header class="top-bar">

        <div class="icon-wrapper">
            <span class="icon-label"></span>
        </div>

        <h1 class="page-title">Profil verwalten</h1>

        <div class="header-right-action menu-wrapper">
            <span class="hamburger-icon" @onclick="ToggleLogoutMenu">☰</span>
            @if (_showLogout)
            {
            <div class="logout-menu comic-box">
                <p @onclick="Session.Logout">Logout ➜]</p>
            </div>
            }
        </div>
    </header>

    <div class="scroll-content">

        @* --- PROFILBILD-KARUSSELL & BIOGRAFIE --- *@
        <div class="management-box comic-box profile-info-box">

            <h3 class="box-title">Profilbild & Biografie</h3>

            <h4 class="tag-headline">Wähle dein Profilbild</h4>

            <div class="profile-carousel-hybrid">

                @* Pfeil Links *@
                <button class="arrow-nav-button secondary-button"
                        @onclick="SelectPreviousProfile">
                    <i class="bi bi-caret-left-fill"></i>
                </button>

                @* Vorschau Links (Vorgänger-Bild)*@
                <div class="profile-preview-container-hybrid">
                    <img src="@($"pictures/Profilbilder/{GetProfileName(_currentIndex - 1)}")"
                         alt="Vorschau"
                         class="profile-image-preview" />
                </div>

                @* Zentrales, ausgewähltes Bild*@
                <div class="profile-main-image-container-hybrid selected-outline-hybrid">
                    <img src="@($"pictures/Profilbilder/{_selectedProfilePicture}")"
                         alt="Aktuelles Profilbild"
                         class="profile-image-large" />
                </div>

                @* Vorschau Rechts (Nachfolger-Bild)*@
                <div class="profile-preview-container-hybrid">
                    <img src="@($"pictures/Profilbilder/{GetProfileName(_currentIndex + 1)}")"
                         alt="Vorschau"
                         class="profile-image-preview" />
                </div>

                @* Pfeil Rechts *@
                <button class="arrow-nav-button secondary-button"
                        @onclick="SelectNextProfile">
                    <i class="bi bi-caret-right-fill"></i>
                </button>

            </div>

            @* Strukturierte Biografie Sektion *@
            <div class="input-group">
                <label class="input-label" for="bio-input">Biographie:</label>
                <textarea id="bio-input"
                          class="app-input-comic"
                          @bind="_bioText"
                          placeholder="Erzähle kurz, wer du bist und was du anbaust..."
                          maxlength="150"></textarea>
                <div class="char-counter">@_bioText.Length / 150</div>
            </div>
        </div>

        @* --- Trennlinie --- *@
        <div class="divider"></div>

        @* --- UNVERÄNDERBARE DATEN: Nachname, Vorname, Benutzername --- *@
        <div class="management-box comic-box info-box">
            <h3 class="box-title">Basis-Informationen (nicht änderbar)</h3>

            <div class="info-item">
                <label>Nachname:</label>
                <p>@_lastName</p>
            </div>

            <div class="info-item">
                <label>Vorname:</label>
                <p>@_firstName</p>
            </div>

            <div class="info-item">
                <label>Benutzername:</label>
                <p>@_profileName</p>
            </div>
        </div>

        @* --- Trennlinie --- *@
        <div class="divider"></div>

        @* --- EDITIERBARE KONTAKTDATEN: Email & Telefonnummer --- *@
        <div class="management-box comic-box contact-box">
            <h3 class="box-title">Kontaktdaten bearbeiten</h3>

            @* E-Mail *@
            <div class="input-group">
                <label for="email-input">Email</label>
                <input id="email-input"
                       class="app-input @(!EmailValid ? "input-error" : "")"
                       type="email"
                       @bind="_email"
                       @bind:event="oninput" />
                @if (!EmailValid)
                {
                <p class="inline-error error-text">⚠️ Ungültige Email-Adresse.</p>
                }
            </div>

            @* Telefonnummer *@
            <div class="input-group">
                <label for="phone-input">Telefonnummer</label>
                <input id="phone-input"
                       class="app-input"
                       type="tel"
                       placeholder="+49123456789"
                       @bind="_phoneNumber"
                       @bind:event="oninput" />
            </div>

            @* Kontaktfreigabe Checkboxen *@
            <h4 class="share-title">Kontaktdaten freigeben</h4>
            <div class="share-options-grid">
                <div class="form-check-group">
                    <div class="form-check-custom">
                        <input class="app-check-input" type="checkbox" id="shareEmail" @bind="_shareEmail" @bind:event="onchange" />
                        <label class="app-check-label" for="shareEmail">Email freigeben</label>
                    </div>
                </div>

                <div class="form-check-group">
                    <div class="form-check-custom">
                        <input class="app-check-input" type="checkbox" id="shareTel" @bind="_sharePhoneNumber" @bind:event="onchange" />
                        <label class="app-check-label" for="shareTel">Telefon freigeben</label>
                    </div>
                </div>
            </div>
        </div>

        @* --- PASSWORT ÄNDERN --- *@
        <div class="management-box comic-box password-box">
            <h3 class="box-title">Passwort ändern</h3>

            @* Neues Passwort *@
            <div class="input-group">
                <label>Neues Passwort</label>
                <input class="app-input @(!string.IsNullOrWhiteSpace(_newPassword) && !IsPasswordStrong ? "input-error" : "")"
                       type="password"
                       @bind="_newPassword"
                       @bind:event="oninput"
                       placeholder="Neues Passwort" />
            </div>

            @* Passwort Anforderungen *@
            @if (!string.IsNullOrWhiteSpace(_newPassword))
            {
            <div class="password-requirements">
                <h5 class="req-title">Anforderungen:</h5>
                <ul>
                    <li class="@(HasMinimumLength ? "passed" : "")">
                        @GetRequirementIcon(HasMinimumLength) Mindestens 8 Zeichen.
                    </li>
                    <li class="@(HasUppercase ? "passed" : "")">
                        @GetRequirementIcon(HasUppercase) Großbuchstaben.
                    </li>
                    <li class="@(HasLowercase ? "passed" : "")">
                        @GetRequirementIcon(HasLowercase) Kleinbuchstaben.
                    </li>
                    <li class="@(HasDigit ? "passed" : "")">
                        @GetRequirementIcon(HasDigit) Ziffer (0-9).
                    </li>
                    <li class="@(HasSpecialChar ? "passed" : "")">
                        @GetRequirementIcon(HasSpecialChar) Sonderzeichen (@GetSpecialChars()).
                    </li>
                </ul>
            </div>
            }

            @* Neues Passwort bestätigen *@
            <div class="input-group confirm-password-group">
                <label>Passwort bestätigen</label>
                <input class="app-input @(PasswordMismatch ? "input-error" : "")"
                       type="password"
                       @bind="_confirmNewPassword"
                       @bind:event="oninput"
                       placeholder="Passwort wiederholen" />

                @if (PasswordMismatch)
                {
                <p class="inline-error error-text">⚠️ Die Passwörter stimmen nicht überein.</p>
                }
            </div>
        </div>
        
        @* --- Änderungen Speichern Button --- *@
        <button class="save-button purple-button"
                @onclick="SaveChanges"
                disabled="@(!CanSaveChanges)">
            Änderungen speichern
        </button>

        @if (!CanSaveChanges)
        {
            <div class="disabled-hint save-hint">
                @if (!CanSaveChanges)
                {
                    <p class="error-text">⚠️ Bitte geben Sie mindestens eine Kontaktmöglichkeit an (Email oder Telefon).</p>
                }
                @if (!EmailValid)
                {
                    <p class="error-text">⚠️ Ungültige E-Mail-Adresse.</p>
                }
                @if (!PasswordChangeValid)
                {
                    <p class="error-text">⚠️ Bitte korrigieren Sie die Passwortfelder.</p>
                }
            </div>
        }
    </div>

    @* --- Bottom Nav --- *@
    <footer class="bottom-nav"></footer>
</div>

@code {
    // --- Statische (nicht änderbare) Benutzerdaten ---
    private string _lastName = "";
    private string _firstName = "";
    private string _profileName = "";
    
    // --- Bearbeitbare Felder ---
    private string _profilePicture = "";
    //------
    
    private string _bioText = "";
    private string _email = "";
    private string _phoneNumber = "";
    private bool _shareEmail;
    private bool _sharePhoneNumber;
    // --- Passwort Felder ---                
    private string _newPassword = "";         
    private string _confirmNewPassword = "";  
    
    private string _selectedProfilePicture = ""; 
    private int _currentIndex = 0;
    
    // UI/Steuerungsfelder
    private bool _showLogout = false;
    private int? _showDeletePopupIndex = null;
    private int? _hoveredIndex = null;

    protected override void OnInitialized()
    {
        //Überprüfung
        //Wenn kein Profil im CurrentProfileState -> zurück zur Startseite
        if (CurrentProfile.LoggedInProfile is null)
        {
            Nav.NavigateTo("/");
            return;
        }
    
        if (CurrentProfile.ShareMail is null || CurrentProfile.Phonenumber is null)
        {
            Nav.NavigateTo("/");
            return;
        }
    
        //Initialisierung der Profildaten
        _profilePicture = CurrentProfile.ProfilepictureUrl ?? "";
        _lastName = CurrentProfile.LastName ?? "";
        _firstName = CurrentProfile.FirstName ?? "";
        _profileName = CurrentProfile.UserName ?? "";
        _bioText = CurrentProfile.Profiletext ?? "";
        _email = CurrentProfile.EMail ?? "";
        _phoneNumber = CurrentProfile.Phonenumber ?? "";
        _shareEmail = CurrentProfile.ShareMail.Value;
        _sharePhoneNumber = CurrentProfile.SharePhoneNumber.Value;
    
        //ProfilBild-"Karusell" vorbereitenPasswort1!
        var currentFileName = Path.GetFileName(_profilePicture);
    
        var idx = ProfilePictureCatalog.profilePictures
            .Select((name, index) => new { name, index })
            .Where(x => x.name == currentFileName)
            .Select(x => x.index)
            .DefaultIfEmpty(-1)
            .First();
    
        if (idx >= 0)
        {
            _currentIndex = idx;
            _selectedProfilePicture = ProfilePictureCatalog.profilePictures[_currentIndex];
        }
        else
        {
            // Fallback: erstes Bild aus dem Catalog
            _currentIndex = 0;
            _selectedProfilePicture = ProfilePictureCatalog.profilePictures.Count > 0
                ? ProfilePictureCatalog.profilePictures[0]
                : "";
        }
    }
    
    // ====================================== 
    // PROFILEPICTURE-HANDLING            
    // ====================================== 
    
    private string GetProfileName(int index)
    {
        int count = ProfilePictureCatalog.profilePictures.Count;
        int effectiveIndex = (index % count + count) % count;
        return ProfilePictureCatalog.profilePictures[effectiveIndex];
    }
    
    private void SelectNextProfile()
    {
        _currentIndex = (_currentIndex + 1) % ProfilePictureCatalog.profilePictures.Count;
        _selectedProfilePicture = ProfilePictureCatalog.profilePictures[_currentIndex];
    }
    //
    private void SelectPreviousProfile()
    {
        _currentIndex = (_currentIndex - 1 + ProfilePictureCatalog.profilePictures.Count) 
                       % ProfilePictureCatalog.profilePictures.Count;
        _selectedProfilePicture = ProfilePictureCatalog.profilePictures[_currentIndex];
    }
    
    // ======================================
    // VALIDIERUNG & LOGIK (C#)
    // ======================================

    //Email Validierung
    public static bool IsValidEmail(string email)
    {
        if (string.IsNullOrWhiteSpace(email)) return true;
        try
        {
            var addr = new EmailAddressAttribute();
            return addr.IsValid(email);
        }
        catch { return false; }
    }

    // -- Passwort Validierung --
    private bool HasMinimumLength => _newPassword.Length >= 8;
    private bool HasUppercase => Regex.IsMatch(_newPassword, @"[A-Z]");
    private bool HasLowercase => Regex.IsMatch(_newPassword, @"[a-z]");
    private bool HasDigit => Regex.IsMatch(_newPassword, @"[0-9]");
    private bool HasSpecialChar => Regex.IsMatch(_newPassword, @"[#?!@$%^&*-]");
    private bool IsPasswordStrong => HasMinimumLength && HasUppercase && HasLowercase && HasDigit && HasSpecialChar;

    private bool PasswordMismatch =>
        !string.IsNullOrWhiteSpace(_newPassword) && !string.IsNullOrWhiteSpace(_confirmNewPassword) && (_newPassword != _confirmNewPassword);

    private bool IsNewPasswordSectionActive => !string.IsNullOrWhiteSpace(_newPassword) || !string.IsNullOrWhiteSpace(_confirmNewPassword);

    private bool PasswordChangeValid => 
        !IsNewPasswordSectionActive || (IsNewPasswordSectionActive && IsPasswordStrong && !PasswordMismatch);

    private MarkupString GetRequirementIcon(bool passed) =>
        passed ? (MarkupString)"<span class=\"check-icon\">✔</span>" : (MarkupString)"<span class=\"fail-icon\">✗</span>";
    private string GetSpecialChars() => "#?!@$%^&*-";

    // Email ist Pflichtfeld und muss gültig sein
    private bool EmailProvidedAndValid => !string.IsNullOrWhiteSpace(_email) && IsValidEmail(_email);

    // Telefon ist Pflichtfeld
    private bool PhoneProvided => !string.IsNullOrWhiteSpace(_phoneNumber);

    // Mindestens eine Freigabe muss aktiv sein
    private bool HasAtLeastOneContactShared => _shareEmail || _sharePhoneNumber;

    // Für UI (rot markieren)
    private bool EmailValid => EmailProvidedAndValid;

    // Gesamt: Speichern nur erlaubt, wenn Email + Telefon gesetzt sind, mind. eine Freigabe aktiv ist und Passwortteil ok ist
    private bool CanSaveChanges => EmailProvidedAndValid && PhoneProvided && HasAtLeastOneContactShared && PasswordChangeValid;

    // ======================================
    // AKTIONEN
    // ======================================
    
    private void ToggleLogoutMenu() => _showLogout = !_showLogout;
    
    private void SaveChanges()
    {
        if (!CanSaveChanges)
            return;

        var updateProfileDto = new PrivateProfileDto
        {
            ProfileId = CurrentProfile.ProfileId.Value,
            ProfilepictureUrl = $"pictures/Profilbilder/{_selectedProfilePicture}",
            EMail = _email.Trim(),
            Phonenumber = _phoneNumber.Trim(),
            Profiletext = _bioText.Trim(),
            ShareMail = _shareEmail,
            SharePhoneNumber = _sharePhoneNumber,
        };

        try
        {
            ProfileMgm.UpdateProfile(updateProfileDto);

            if (PasswordChangeValid && !string.IsNullOrWhiteSpace(_newPassword))
            {
                var credentialDto = new CredentialProfileDto
                {
                    EMail = _email.Trim(),
                    PasswordHash = _newPassword
                };

                ProfileMgm.UpdateCredentials(credentialDto);
            }

            CurrentProfile.RefreshProfile(ProfileMgm);
            Nav.NavigateTo("/EigenesUserProfil");
        }
        catch (Exception e)
        {
            Console.WriteLine(e);
        }
    }
}
