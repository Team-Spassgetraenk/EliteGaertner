@page "/ProfilTest"
@using Microsoft.AspNetCore.Components.Web
@inject NavigationManager Nav
@rendermode InteractiveServer

<link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&display=swap" rel="stylesheet">

<div class="page-container background-style">

    @* --- TOP BAR --- *@
    <header class="top-bar">
        <div class="icon-wrapper" @onclick="GoToRanks">
            <img src="pictures/Rangliste.png" alt="Rangliste" height="40" />
            <span class="icon-label">Rangliste</span>
        </div>

        <h1 class="page-title">Mein Profil</h1>

        <div class="header-right-action menu-wrapper">
            <span class="hamburger-icon" @onclick="ToggleLogoutMenu">‚ò∞</span>
            @if (_showLogout)
            {
            <div class="logout-menu comic-box">
                <p @onclick="NavigateToLogout">Logout ‚ûú]</p>
            </div>
            }
        </div>
    </header>

    @* --- HAUPTBEREICH (Zweispaltig) --- *@
    <div class="main-profile-layout">

        @* LINKE SPALTE: Meine Informationen *@
        <aside class="left-column">
            <div class="profile-header-box comic-box">
                @* Profil Verwalten Button *@
                <div class="profile-manage-button-in-box" @onclick="GoToManageProfile">
                    <img src="pictures/EinstellungenIcon.png" alt="Einstellungen" height="22" />
                    <span class="manage-text">Profil verwalten</span>
                </div>

                <div class="profile-info">
                    <div class="profile-pic-placeholder">
                        <img src="pictures/Profilbilder/Profilbild_28.png" alt="Profilbild" class="profile-pic" />
                    </div>
                    <h2 class="username-display">@@MaisM√§drescher</h2>
                </div>

                <div class="divider"></div>
                <p class="profile-description">@_bioText</p>
            </div>
        </aside>

        @* RECHTE SPALTE: Meine HarvestUploads *@
        <main class="right-column">
            <div class="harvest-gallery-box comic-box gallery-scroll-container">
                <div class="harvest-grid">
                    
                    @* --- neue Ernte Hochladen --- *@
                    <div class="grid-item comic-grid-item upload-btn-container" @onclick="AddPhoto">
                        <div class="upload-btn-content">
                            <span class="plus-emoji">‚ûï</span>
                            <span class="upload-text">Neue Ernte hochladen</span>
                        </div>
                    </div>
                    
                    @* --- HarvestUploads ---  *@
                    @for (int i = 0; i < _harvestDetails.Count; i++)
                    {
                        // Lokale Kopie des Index f√ºr Lambda-Ausdr√ºcke (wichtig in Blazor!)
                        int index = i;
                        var h = _harvestDetails[i];

                        <div class="grid-item comic-grid-item" style="position: relative;">
                            @* HarvestUpload *@
                            <img src="@h.ImageUrl" alt="Erntebild" class="harvest-photo"
                                 @onclick="() => _selectedHarvest = h" style="cursor: pointer;"/>

                            @* L√∂sch-Icon (Oben rechts im Eck des Bildes) *@
                            <div class="delete-overlay" @onclick="() => ToggleDeletePopup(index)">
                                <span class="delete-icon" style="color: #FFFFFF">‚úñ</span>
                            </div>

                            @* Das L√∂sch-Best√§tigungs-Popup *@
                            @if (_showDeletePopupIndex == index)
                            {
                                <div class="delete-popup comic-box" @onclick="() => DeletePhoto(h)">
                                    Bild l√∂schen
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>
        </main>
    </div>

    @* --- DETAILANSICHT DER HARVESTUPLOADS --- *@
    @if (_selectedHarvest != null)
    {
        <div class="detail-overlay-backdrop" @onclick="() => _selectedHarvest = null">
            <div class="tinder-wrapper-card" @onclick:stopPropagation="true">
                <span class="close-x" @onclick="() => _selectedHarvest = null">‚úñ</span>
                <div class="main-content-flex">
                    <div class="tinder-card">
                        <div class="card-image-placeholder">
                            <img src="@_selectedHarvest.ImageUrl" alt="Ernte" class="harvest-image" />
                        </div>
                        <div class="username-tag-combo">
                            <span class="username-label">@_selectedHarvest.Tag</span>
                        </div>
                    </div>

                    <div class="right-info-stack">
                        <div class="parameter-wrapper-vertical">
                            <div class="white-comic-box">
                                <div class="param-icon-circle">‚öñÔ∏è</div>
                                <div class="param-content-wrapper">
                                    <p class="param-title">Gewicht</p>
                                    <p class="param-value">@_selectedHarvest.Weight</p>
                                </div>
                            </div>
                            <div class="white-comic-box">
                                <div class="param-icon-circle">üìè</div>
                                <div class="param-content-wrapper">
                                    <p class="param-title">L√§nge</p>
                                    <p class="param-value">@_selectedHarvest.Length</p>
                                </div>
                            </div>
                            <div class="white-comic-box">
                                <div class="param-icon-circle">üìê</div>
                                <div class="param-content-wrapper">
                                    <p class="param-title">Breite</p>
                                    <p class="param-value">@_selectedHarvest.Width</p>
                                </div>
                            </div>
                        </div>

                        <div class="comment-box white-comic-box">
                            <p class="comment-label">Erntebeschreibung</p>
                            <p class="comment-text">@_selectedHarvest.Description</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }

    @* --- BOTTOM NAV --- *@
    <footer class="bottom-nav">
        <div class="nav-item" @onclick="GoToMatches">
            <img src="pictures/MatchesIcon.png" alt="Matches" height="40" />
            <span>Matches</span>
        </div>
        <div class="nav-item" @onclick="GoToMainpage">
            <img src="pictures/EliteG√§rtner_logo.png" alt="EliteG√§rtner" height="40" />
            <span class="elitegaertner-title mt-2">EliteG√§rtner.</span>
        </div>
        <div class="nav-item" @onclick="GoToProfile">
            <img src="pictures/Profil_04.png" alt="Profile" height="40" />
            <span>Profil</span>
        </div>
    </footer>
</div>

@code {
    private int? _showDeletePopupIndex = null;
    private int? _hoveredIndex = null;
    
    private string _bioText = "Hier steht die Profilbeschreibung... Leidenschaftlicher Z√ºchter seltener Tomatensorten und Gurken-Enthusiast seit Anbeginn der Zeit.";

// Bild-L√∂sch Logik
private void SetHoveredIndex(int index) => _hoveredIndex = index;
private void ResetHoveredIndex() => _hoveredIndex = null;

private void ToggleDeletePopup(int index)
{
    if (_showDeletePopupIndex == index)
    {
        _showDeletePopupIndex = null;
    }
    else
    {
        _showDeletePopupIndex = index;
    }
}

private void DeletePhoto(HarvestDetail item)
{
    if (item != null)
    {
        _harvestDetails.Remove(item);
        _showDeletePopupIndex = null; // Popup schlie√üen
        StateHasChanged(); // UI aktualisieren
    }
}

// Detailansicht HarvestUploads
private List<HarvestDetail> _harvestDetails = new()
{
    new() { ImageUrl="pictures/Testbilder/Gurken_01.jpg", Tag="Gurken ü•í", Weight="320g", Length="22cm", Width="5cm", Description="Sehr knackig dieses Jahr!" },
    new() { ImageUrl="pictures/Testbilder/Karotten_01.jpg", Tag="Karotten ü•ï", Weight="150g", Length="18cm", Width="3cm", Description="Direkt aus dem Hochbeet." },
    new() { ImageUrl="pictures/Testbilder/K√ºrbisse_01.jpg", Tag="K√ºrbis üéÉ", Weight="4.2kg", Length="35cm", Width="40cm", Description="Prachtexemplar f√ºr Halloween." },
    new() { ImageUrl="pictures/Testbilder/Auberginen_01.jpg", Tag="Auberginen üçÜ", Weight="400g", Length="15cm", Width="8cm", Description="Viel Sonne getankt." },
    new() { ImageUrl="pictures/Testbilder/Erdbeeren_01.jpg", Tag="Erdbeeren üçì", Weight="45g", Length="5cm", Width="4cm", Description="Zuckers√º√ü!" },
    new() { ImageUrl="pictures/Testbilder/Trauben_01.jpg", Tag="Trauben üçá", Weight="600g", Length="20cm", Width="12cm", Description="Sorte: Muskat." }
};

private HarvestDetail? _selectedHarvest;

private bool _showLogout = false;

public class GridItem {
public bool IsImage { get; set; }
public bool IsAddButton { get; set; }
public string Path { get; set; } = "";
}


private void ToggleLogoutMenu() => _showLogout = !_showLogout;
private void NavigateToLogout() => Nav.NavigateTo("/", forceLoad: true);
private void GoToRanks() => Nav.NavigateTo("/RanglisteTest", forceLoad: true);
private void GoToMatches() => Nav.NavigateTo("/MatchesTest", forceLoad: true);
private void GoToMainpage() => Nav.NavigateTo("/startseite", forceLoad: true);
private void GoToProfile() => Nav.NavigateTo("/ProfilTest", forceLoad: true);
private void GoToManageProfile() => Nav.NavigateTo("/profil/profilverwaltung", forceLoad: true);
private void AddPhoto() => Nav.NavigateTo("/ernte-hochladen", forceLoad: true);

private class HarvestDetail {
    public string ImageUrl { get; set; } = "";
    public string Tag { get; set; } = "";
    public string Weight { get; set; } = "";
    public string Length { get; set; } = "";
    public string Width { get; set; } = "";
    public string Description { get; set; } = "";
}
}