@page "/EigenesUserProfil"
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.Extensions.Logging
@using PresentationLayer.Services
@using PresentationLayer.State
@using PresentationLayer.Shared
@using System.Linq
@using AppLogic.Interfaces
@using AppLogic.Services
@using DataManagement.Interfaces
@inject IHarvestDbs HarvestDbs
@inject IUploadService UploadService
@inject IProfileMgm ProfileMgm
@inject IImageUploadService ImageUploadService
@inject CurrentProfileState CurrentProfile
@inject SessionService Session
@inject NavigationManager Nav
@inject ILogger<EigenesUserProfil> Logger
@implements IDisposable


<link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&display=swap" rel="stylesheet">

<div class="page-container background-style">
    <header class="top-bar">
        @* Linke Seite *@
        <div class="icon-wrapper left" @onclick="GoToRanks">
            <img src="pictures/Rangliste.png" alt="Rangliste" height="40" />
            <span class="icon-label">Rangliste</span>
        </div>

        @* Mitte (wird durch CSS absolut zentriert) *@
        <h1 class="page-title">Mein Profil</h1>

        @* Rechte Seite *@
        <div class="header-right-group" style="display: flex; align-items: center; gap: 20px;">
            @if (!string.IsNullOrEmpty(CurrentProfile.UserName))
            {
                <span class="logged-in-user" style="font-weight: bold; font-size: 1.5rem;">
                    üë§ @($"@{CurrentProfile.UserName}")
                </span>
            }
            <div class="menu-icon-container" @onclick="ToggleLogoutMenu">
                <span class="menu-icon">‚ò∞</span>
            </div>
        </div>
    </header>
    
    @if (_showLogout)
    {
        <div class="logout-menu admin-menu-ext">
            <p class="logout-link" @onclick="Session.Logout">Logout ‚ûú]</p>  
            <div class="admin-header" @onclick="NavigateToAboutUs">
                <span>‚ÑπÔ∏è √úber uns</span>
            </div>
        </div>
    }

    @* --- HAUPTBEREICH (Zweispaltig) --- *@
    <div class="main-profile-layout">

        @* LINKE SPALTE: Meine Informationen *@
        <aside class="left-column">
            <div class="profile-header-box comic-box">
                @* Profil Verwalten Button *@
                <div class="profile-manage-button-in-box" @onclick="GoToManageProfile">
                    <img src="pictures/EinstellungenIcon.png" alt="Einstellungen" height="22" />
                    <span class="manage-text">Profil verwalten</span>
                </div>

                <div class="profile-info">
                    <div class="profile-pic-placeholder">
                        <img src="@_profilePictureUrl" alt="Profilbild" class="profile-pic" />
                    </div>
                    <h2 class="username-display">@_profileName</h2>
                </div>

                <div class="divider"></div>
                <p class="profile-description">@_bioText</p>
            </div>
        </aside>

        @* RECHTE SPALTE: Meine HarvestUploads *@
        <main class="right-column">
            <div class="harvest-gallery-box comic-box gallery-scroll-container">
                <div class="harvest-grid">
                    
                    @* --- neue Ernte Hochladen --- *@
                    <div class="grid-item comic-grid-item upload-btn-container" @onclick="AddPhoto">
                        <div class="upload-btn-content">
                            <span class="plus-emoji">‚ûï</span>
                            <span class="upload-text">Neue Ernte hochladen</span>
                        </div>
                    </div>
                    
                    @* --- HarvestUploads ---  *@
                    @for (int i = 0; i < _profileHarvestUploads.Count; i++)
                    {
                        // Lokale Kopie des Index f√ºr Lambda-Ausdr√ºcke (wichtig in Blazor!)
                        int index = i;
                        var h = _profileHarvestUploads[i];

                        <div class="grid-item comic-grid-item" style="position: relative;">
                            @* HarvestUpload *@
                            <img src="@h.ImageUrl" alt="Erntebild" class="harvest-photo"
                                 @onclick="() => _selectedHarvest = h" style="cursor: pointer;"/>

                            @* L√∂sch-Icon (Oben rechts im Eck des Bildes) *@
                            <div class="delete-overlay" @onclick="() => ToggleDeletePopup(index)">
                                <span class="delete-icon" style="color: #FFFFFF">‚úñ</span>
                            </div>

                            @* Das L√∂sch-Best√§tigungs-Popup *@
                            @if (_showDeletePopupIndex == index)
                            {
                                <div class="delete-popup comic-box" @onclick="async () => await DeletePhoto(h)">
                                    Bild l√∂schen
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>
        </main>
    </div>

    @* --- DETAILANSICHT DER HARVESTUPLOADS --- *@
    @if (_selectedHarvest != null)
    {
        <div class="detail-overlay-backdrop" @onclick="() => _selectedHarvest = null">
            <div class="tinder-wrapper-card" @onclick:stopPropagation="true">
                <span class="close-x" @onclick="() => _selectedHarvest = null">‚úñ</span>
                <div class="main-content-flex">
                    <div class="tinder-card">
                        <div class="card-image-placeholder">
                            <img src="@_selectedHarvest.ImageUrl" alt="Ernte" class="harvest-image" />
                        </div>
                        <div class="username-tag-combo">
                            <span class="username-label">@_profileName</span>
                            <div class="tag-label">
                                <span>@GetPrimaryTagLabel(_selectedHarvest)</span>
                            </div>
                        </div>
                    </div>

                    <div class="right-info-stack">
                        <div class="parameter-wrapper-vertical">
                            <div class="white-comic-box">
                                <div class="param-icon-circle">‚öñÔ∏è</div>
                                <div class="param-content-wrapper">
                                    <p class="param-title">Gewicht</p>
                                    <p class="param-value">@_selectedHarvest.WeightGram g</p>
                                </div>
                            </div>
                            <div class="white-comic-box">
                                <div class="param-icon-circle">üìè</div>
                                <div class="param-content-wrapper">
                                    <p class="param-title">L√§nge</p>
                                    <p class="param-value">@_selectedHarvest.LengthCm cm</p>
                                </div>
                            </div>
                            <div class="white-comic-box">
                                <div class="param-icon-circle">üìê</div>
                                <div class="param-content-wrapper">
                                    <p class="param-title">Breite</p>
                                    <p class="param-value">@_selectedHarvest.WidthCm cm</p>
                                </div>
                            </div>
                        </div>

                        <div class="comment-box white-comic-box">
                            <p class="comment-label">Erntebeschreibung</p>
                            <p class="comment-text">@_selectedHarvest.Description</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }

    @* --- BOTTOM NAV --- *@
    <footer class="bottom-nav">
        <div class="nav-item active" @onclick="GoToMatches">
            <img src="pictures/MatchesIcon.png" alt="Matches" height="40" />
            <span>Matches</span>
        </div>

        <div class="nav-item" @onclick="GoToMainpage">
            <img src="pictures/EliteG√§rtner_logo.png" alt="EliteG√§rtner" height="40" />
            <span class="elitegaertner-title mt-2" style="font-weight: 600; font-size: 1.0rem">EliteG√§rtner.</span>
        </div>

        <div class="nav-item" @onclick="GoToProfile">
            <img src="pictures/Profil_04.png" alt="Profile" height="40" />
            <span>Profil</span>
        </div>
    </footer>
</div>

@code {
    private int? _showDeletePopupIndex = null;
    
    // UI State
    private string _loggedInUserName = "";

    //Profildaten
    private string _profileName;
    private string _profilePictureUrl;
    private string _bioText;
    private List<HarvestUploadDto> _profileHarvestUploads = new ();

    private HarvestUploadDto? _selectedHarvest;

    private bool _showLogout = false;

    protected override void OnInitialized()
    {
        Logger.LogInformation("EigenesUserProfil: OnInitialized started");

        //√úberpr√ºfung
        //Wenn kein Profil im CurrentProfileState -> zur√ºck zur Startseite
        if (CurrentProfile.LoggedInProfile is null)
        {
            Logger.LogWarning("EigenesUserProfil: No logged-in profile found. Redirecting to '/'.");
            Nav.NavigateTo("/");
            return;
        }
        
        CurrentProfile.Onchange += StateHasChanged;
        Logger.LogDebug("EigenesUserProfil: Subscribed to CurrentProfile.Onchange");
        
        //Zuweisung der Currentprofile
        _profileName = "@" + CurrentProfile.UserName;
        _profilePictureUrl = CurrentProfile.ProfilepictureUrl ?? "";
        _bioText = CurrentProfile.Profiletext ?? "";
        _profileHarvestUploads = CurrentProfile.HarvestUploads?.ToList() ?? new List<HarvestUploadDto>();

        Logger.LogInformation(
            "EigenesUserProfil: Profile loaded. UserName={UserName}, HarvestUploads={UploadCount}",
            _profileName,
            _profileHarvestUploads.Count);
    }
    
    //Nimm TagId, mappe ihm mit dem TagCatalog und render den passenden String
    private static string GetPrimaryTagLabel(HarvestUploadDto? harvest)
    {
        var firstTagId = harvest?.TagIds?.FirstOrDefault() ?? 0;
        if (firstTagId <= 0)
            return string.Empty;

        var tagItem = TagCatalog.FindById(firstTagId);
        return tagItem is null ? string.Empty : $"{tagItem.Icon} {tagItem.Name}";
    }

    private void ToggleDeletePopup(int index)
    {
        Logger.LogDebug("EigenesUserProfil: ToggleDeletePopup called. Index={Index}, CurrentPopupIndex={CurrentPopupIndex}", index, _showDeletePopupIndex);

        if (_showDeletePopupIndex == index)
        {
            _showDeletePopupIndex = null;
        }
        else
        {
            _showDeletePopupIndex = index;
        }

        Logger.LogDebug("EigenesUserProfil: ToggleDeletePopup finished. NewPopupIndex={NewPopupIndex}", _showDeletePopupIndex);
    }
    
    public void Dispose()
    {
        Logger.LogDebug("EigenesUserProfil: Dispose called. Unsubscribing from CurrentProfile.Onchange");
        CurrentProfile.Onchange -= StateHasChanged;
    }
    
    private async Task DeletePhoto(HarvestUploadDto harvestUpload)
    {
        if (harvestUpload is null)
            return;

        Logger.LogInformation(
            "EigenesUserProfil: DeletePhoto requested. UploadId={UploadId}, ImageUrl={ImageUrl}",
            harvestUpload.UploadId,
            harvestUpload.ImageUrl);

        try
        {
            //L√∂scht den HarvestUpload aus Datenbank + Webroot
            ImageUploadService.TryDeleteByRelativeUrl(UploadService.DeleteHarvestUpload(harvestUpload.UploadId));
            Logger.LogInformation("EigenesUserProfil: DeletePhoto succeeded. UploadId={UploadId}", harvestUpload.UploadId);

            //UI schlie√üen
            _showDeletePopupIndex = null;
            if (_selectedHarvest?.UploadId == harvestUpload.UploadId)
                _selectedHarvest = null;

            //State neu laden + lokale Liste aktualisieren
            CurrentProfile.RefreshProfile(ProfileMgm);
            _profileHarvestUploads = CurrentProfile.HarvestUploads?.ToList() ?? new List<HarvestUploadDto>();
            Logger.LogDebug(
                "EigenesUserProfil: Profile refreshed after delete. HarvestUploads={UploadCount}",
                _profileHarvestUploads.Count);

            await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "EigenesUserProfil: DeletePhoto failed. UploadId={UploadId}", harvestUpload.UploadId);
            Console.WriteLine("DeletePhoto failed:");
            Console.WriteLine(ex);
        }
    }
    
    //Navigation
    private void ToggleLogoutMenu()
    {
        _showLogout = !_showLogout;
        Logger.LogDebug("EigenesUserProfil: ToggleLogoutMenu. ShowLogout={ShowLogout}", _showLogout);
    }
    
    private void NavigateToAboutUs()
    {
        Logger.LogInformation("EigenesUserProfil: Navigation -> Ueber-Uns.");
        Nav.NavigateTo("/ueber-uns");
    }

    private void GoToRanks()
    {
        Logger.LogInformation("EigenesUserProfil: Navigate to Rangliste");
        Nav.NavigateTo("/Rangliste");
    }

    private void GoToMatches()
    {
        Logger.LogInformation("EigenesUserProfil: Navigate to Matches");
        Nav.NavigateTo("/matches");
    }

    private void GoToMainpage()
    {
        Logger.LogInformation("EigenesUserProfil: Navigate to Startseite");
        Nav.NavigateTo("/startseite");
    }

    private void GoToProfile()
    {
        Logger.LogInformation("EigenesUserProfil: Navigate to EigenesUserProfil");
        Nav.NavigateTo("/EigenesUserProfil");
    }

    private void GoToManageProfile()
    {
        Logger.LogInformation("EigenesUserProfil: Navigate to Profilverwaltung");
        Nav.NavigateTo("/profil/profilverwaltung");
    }

    private void AddPhoto()
    {
        Logger.LogInformation("EigenesUserProfil: Navigate to Ernte hochladen privat");
        Nav.NavigateTo("/ernte-hochladen-privat");
    }
}