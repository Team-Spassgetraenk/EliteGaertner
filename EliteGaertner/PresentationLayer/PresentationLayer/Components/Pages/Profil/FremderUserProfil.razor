@page "/profil/{ProfileId:int}"
@using AppLogic.Interfaces
@using AppLogic.Services
@using PresentationLayer.Services
@using PresentationLayer.State
@using Contracts.Data_Transfer_Objects
@using Microsoft.AspNetCore.Components
@using PresentationLayer.Shared
@inject IProfileMgm ProfileMgm
@inject CurrentProfileState CurrentProfile
@inject SessionService Session
@inject NavigationManager Nav


<link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&display=swap" rel="stylesheet">

<div class="page-container background-style">

    @* --- TOP BAR --- *@
    <header class="top-bar">
        <div class="icon-wrapper" @onclick="GoToRanks">
            <img src="pictures/Rangliste.png" alt="Rangliste" height="40" />
            <span class="icon-label">Rangliste</span>
        </div>

        <h1 class="page-title">EliteG√§rtner.</h1>

        <div class="header-right-action menu-wrapper">
            <span class="hamburger-icon" @onclick="ToggleLogoutMenu" style="cursor:pointer; font-size:30px;">‚ò∞</span>
            @if (_showLogout)
            {
                <div class="logout-menu comic-box">
                    <p @onclick="Session.Logout" style="cursor:pointer; padding: 5px 10px; margin:0;">Logout &lt;</p>
                </div>
            }
        </div>
    </header>

    @* --- HAUPTBEREICH --- *@
    <div class="main-profile-layout">
        <aside class="left-column">
            <div class="profile-header-box comic-box">
                <div class="profile-pic-placeholder">
                    <img src="@_profilePictureUrl" alt="Profilbild" class="profile-pic" />
                </div>
                <h2 class="username-display">@_profileName</h2>
                <div class="divider"></div>
                <p class="profile-description">@_bioText</p>
            </div>
        </aside>

        <main class="right-column">
            <div class="harvest-gallery-box comic-box gallery-scroll-container">
                <div class="harvest-grid">
                    @foreach (var h in _profileHarvestUploads)
                    {
                        <div class="grid-item comic-grid-item" @onclick="() => _selectedHarvest = h" style="cursor: pointer;">
                            <img src="@h.ImageUrl" alt="Erntebild" class="harvest-photo" />
                        </div>
                    }
                </div>
            </div>
        </main>
    </div>

    @* --- DETAILANSICHT DER HARVESTUPLOADS --- *@
    @if (_selectedHarvest != null)
    {
        <div class="detail-overlay-backdrop" @onclick="() => _selectedHarvest = null">
            <div class="tinder-wrapper-card" @onclick:stopPropagation="true">
                <span class="close-x" @onclick="() => _selectedHarvest = null">‚úñ</span>
                <div class="main-content-flex">
                    <div class="tinder-card">
                        <div class="card-image-placeholder">
                            <img src="@_selectedHarvest.ImageUrl" alt="Ernte" class="harvest-image" />
                        </div>
                        <div class="username-tag-combo">
                            <span class="username-label">@_profileName</span>
                            <div class="tag-label">
                                <span>@GetPrimaryTagLabel(_selectedHarvest)</span>
                            </div>
                        </div>
                    </div>

                    <div class="right-info-stack">
                        <div class="parameter-wrapper-vertical">
                            <div class="white-comic-box">
                                <div class="param-icon-circle">‚öñÔ∏è</div>
                                <div class="param-content-wrapper">
                                    <p class="param-title">Gewicht</p>
                                    <p class="param-value">@_selectedHarvest.WeightGram</p>
                                </div>
                            </div>
                            <div class="white-comic-box">
                                <div class="param-icon-circle">üìè</div>
                                <div class="param-content-wrapper">
                                    <p class="param-title">L√§nge</p>
                                    <p class="param-value">@_selectedHarvest.LengthCm</p>
                                </div>
                            </div>
                            <div class="white-comic-box">
                                <div class="param-icon-circle">üìê</div>
                                <div class="param-content-wrapper">
                                    <p class="param-title">Breite</p>
                                    <p class="param-value">@_selectedHarvest.WidthCm</p>
                                </div>
                            </div>
                        </div>

                        <div class="comment-box white-comic-box">
                            <p class="comment-label">Erntebeschreibung</p>
                            <p class="comment-text">@_selectedHarvest.Description</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }

    @* --- BOTTOM NAV --- *@
    <footer class="bottom-nav">
        <div class="nav-item" @onclick="GoToMatches">
            <img src="pictures/MatchesIcon.png" alt="Matches" height="40" />
            <span>Matches</span>
        </div>
        <div class="nav-item" @onclick="GoToMainpage">
            <img src="pictures/EliteG√§rtner_logo.png" alt="EliteG√§rtner" height="40" />
            <span class="elitegaertner-title mt-2">EliteG√§rtner.</span>
        </div>
        <div class="nav-item" @onclick="GoToProfile">
            <img src="pictures/Profil_04.png" alt="Profile" height="40" />
            <span>Profil</span>
        </div>
    </footer>
</div>

@code {
    
    //Profildaten
    [Parameter]
    public int ProfileId { get; set; }
    private string _profileName = string.Empty;
    private string _profilePictureUrl = string.Empty;
    private string _bioText = string.Empty;
    private List<HarvestUploadDto> _profileHarvestUploads = new();

    private HarvestUploadDto? _selectedHarvest;

    protected override void OnParametersSet()
    {
        // Guard: not logged in
        if (CurrentProfile.LoggedInProfile is null)
        {
            Nav.NavigateTo("/");
            return;
        }

        var publicProfile = ProfileMgm.VisitPublicProfile(ProfileId);
        if (publicProfile is null)
        {
            // Profil existiert nicht (oder Zugriff nicht m√∂glich)
            Nav.NavigateTo("/matches");
            return;
        }

        // Zuweisung des PublicProfiles
        _profileName = "@" + (publicProfile.UserName ?? string.Empty);
        _profilePictureUrl = publicProfile.ProfilepictureUrl ?? string.Empty;
        _bioText = publicProfile.Profiletext ?? string.Empty;
        _profileHarvestUploads = publicProfile.HarvestUploads?.ToList() ?? new List<HarvestUploadDto>();
    }
    
    //Nimm erste TagId, mappe sie mit dem TagCatalog und rendere den passenden String
    private static string GetPrimaryTagLabel(HarvestUploadDto? harvest)
    {
        var firstTagId = harvest?.TagIds?.FirstOrDefault() ?? 0;
        if (firstTagId <= 0)
            return string.Empty;

        var tagItem = TagCatalog.FindById(firstTagId);
        return tagItem is null ? string.Empty : $"{tagItem.Icon} {tagItem.Name}";
    }
    
    private void ToggleLogoutMenu() => _showLogout = !_showLogout;
    private bool _showLogout = false;
    private void GoToRanks() => Nav.NavigateTo("/RanglisteTest");
    private void GoToMatches() => Nav.NavigateTo("/matches");
    private void GoToMainpage() => Nav.NavigateTo("/startseite");
    private void GoToProfile() => Nav.NavigateTo("/EigenesUserProfil");
}