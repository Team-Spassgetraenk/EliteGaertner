@page "/RanglisteTest"
@using PresentationLayer.Services
@using PresentationLayer.Shared
@using PresentationLayer.State
@using AppLogic.Interfaces
@using AppLogic.Services
@using DataManagement.Interfaces

@inject ILeaderBoardDbs LeaderBoardDbs
@inject CurrentProfileState CurrentProfile
@inject SessionService Session
@inject NavigationManager Nav

<link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght=600&display=swap" rel="stylesheet">


<div class="page-container background-style">
    
    <header class="top-bar">
        
        @* NEU: Titelausrichtung f√ºr Rangliste (Kein Link links) *@
        <div class="icon-wrapper left"></div> @* Abstandshalter f√ºr Symmetrie *@

        <h1 class="page-title">Ranglisten</h1>

        <div class="menu-icon-container">
            <span class="menu-icon" @onclick="ToggleLogoutMenu">‚ò∞</span>
        </div>
    </header>

    @if (_showLogout)
    {
    <div class="logout-menu">
        <p @onclick="Session.Logout">Logout ‚ûú</p>
    </div>
    }

    <div class="scroll-content rangliste-content">
        
        <div class="category-selector">
            <span class="current-category">@_currentLeaderboard.LeaderboardTitle</span>
            <span class="dropdown-arrow" @onclick="ToggleCategoryMenu">‚ñº</span>
        </div>
        
        @if (_showLeaderboardMenu)
        {
            <div class="category-dropdown-menu comic-box-dropdown">
                @foreach (var cat in _leaderboardList)
                {
                    <div class="dropdown-item" @onclick="() => SelectCategory(cat)">
                        @cat.LeaderboardTitle
                    </div>
                }
            </div>
        }

        <div class="rangliste-card comic-box-card">
            <div class="trophy-icon">
                <img src="pictures/Rangliste.png" alt="Rangliste" height="80" /> 
            </div>

            @foreach (var entry in _currentLeaderboard.Entries)
            {
                <div class="rank-entry @GetRankCssClass(entry.Rank)" style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
                    <div class="rank-info" @onclick="() => GoToProfile(entry.UserName)">
                        <span class="rank-number">@GetRankPrefix(entry.UserName)@entry.Rank</span>
                        <span class="username-display">@entry.UserName</span>
                    </div>
                    <div class="rank-value" style="margin-left:auto; white-space:nowrap;">
                        <span style="font-weight:600;">@FormatValue(entry.Value, _currentLeaderboard.Goal)</span>
                    </div>
                </div>
            }
        </div>
        
        @* Meine Platzierung *@
        @if (_currentLeaderboard?.PersonalEntry is not null && _currentLeaderboard.PersonalEntry.Rank > 0)
        {
            <div class="rangliste-card comic-box-card my-rank-card">
                <div class="rank-entry current-user-rank" style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
                    <div class="rank-info">
                        <span class="rank-number">#@_currentLeaderboard.PersonalEntry.Rank</span>
                        <span class="username-display">@_currentLeaderboard.PersonalEntry.UserName</span>
                    </div>
                    <div class="rank-value" style="margin-left:auto; white-space:nowrap;">
                        @* Value ist je nach Goal Likes / cm / g *@
                        <span style="font-weight:600;">@FormatValue(_currentLeaderboard.PersonalEntry.Value, _currentLeaderboard.Goal)</span>
                    </div>
                </div>
            </div>
        }
        else
        {
            <div class="rangliste-card comic-box-card my-rank-card">
                <div class="rank-entry default-rank">
                    <div class="rank-info">
                        <span class="username-display">Keine pers√∂nliche Platzierung f√ºr diese Kategorie.</span>
                    </div>
                </div>
            </div>
        }
    </div>

    <footer class="bottom-nav">
        <div class="nav-item" @onclick="GoToMatches">
            <img src="pictures/MatchesIcon.png" alt="Matches" height="40" /> 
            <span>Matches</span>
            @* Roter Punkt (notification-dot) entfernt *@
        </div>
        
        <div class="nav-item" @onclick="GoToMainpage">
            <img src="pictures/EliteG√§rtner_logo.png" alt="EliteG√§rtner" height="40" /> 
            <span class="elitegaertner-title mt-2" style="font-weight: 600; font-size: 1.0rem">EliteG√§rtner.</span>
        </div>
        
        <div class="nav-item" @onclick="GoToProfile">
            <img src="pictures/Profil_04.png" alt="Profile" height="40" /> 
            <span>Profil</span>
        </div>
    </footer>
</div>

@code {

    private bool _showLogout = false; 
    private bool _showLeaderboardMenu = false;
    private List<LeaderboardDto> _leaderboardList = new();
    private LeaderboardDto _currentLeaderboard;
    private ILeaderBoardService _leaderboardService;

    
    
    //TODO Kommentar fehlt
    protected override void OnInitialized()
    {
        
        //√úberpr√ºfung
        //Wenn kein Profil im CurrentProfileState -> zur√ºck zur Startseite
        if (CurrentProfile.LoggedInProfile is null)
        {
            Nav.NavigateTo("/");
            return;
        }
        
        foreach (var leaderboard in LeaderBoardCategories.Leaderboards)
        {
            _leaderboardService = new LeaderboardService(
                leaderboard.LeaderboardTitle,
                leaderboard.LeaderboardId,
                CurrentProfile.ProfileId.Value,
                leaderboard.TagId,
                leaderboard.Goal,
                LeaderBoardDbs
                );
            
            _leaderboardList.Add(_leaderboardService.GetLeaderBoardDto());
        }

        _currentLeaderboard = _leaderboardList.First();

        //TODO TEST MUSS ENTFERNT WERDEN
        foreach (var leaderboard in _leaderboardList)
        {
            Console.WriteLine();
            Console.WriteLine("---LEADERBOARD---");
            Console.WriteLine("Title: " + leaderboard.LeaderboardTitle);
            Console.WriteLine("Anzahl der Entries: " + leaderboard.Entries.Count);
            foreach (var entries in leaderboard.Entries)
            {
                Console.WriteLine("---Next Entry---");
                Console.WriteLine("Entry Rank: " + entries.Rank);
                Console.WriteLine("Entry ProfileId: " + entries.ProfileId);
                Console.WriteLine("Entry Profilename: " + entries.UserName);
                Console.WriteLine("Entry Value: " + entries.Value + "cm");
            }
            Console.WriteLine("-------------------");
            Console.WriteLine("---Personal Entry--");
            Console.WriteLine("Entry Rank: " + leaderboard.PersonalEntry.Rank);
            Console.WriteLine("Entry ProfileId: " + leaderboard.PersonalEntry.ProfileId);
            Console.WriteLine("Entry Profilename: " + leaderboard.PersonalEntry.UserName);
            Console.WriteLine("Entry Value: " + leaderboard.PersonalEntry.Value + "cm");
        }
    }
    
    

    private string GetRankCssClass(int rank)
    {
        if (rank == 1) return "rank-1";
        if (rank == 2) return "rank-2";
        if (rank == 3) return "rank-3";
        //if (_currentLeaderboard.Entr.Any(r => r.Rank == rank && r.IsCurrentUser)) return "current-user-rank";
        return "default-rank";
    }

    //TODO KOMMENTAR FEHLT
    private string FormatValue(float value, LeaderboardSearchGoal goal)
    {
        // Use compact formatting for floats.
        var n = value.ToString("0.##");

        return goal switch
        {
            LeaderboardSearchGoal.MostLikes => $"{n} üíö",
            LeaderboardSearchGoal.Longest   => $"{n} cm",
            LeaderboardSearchGoal.Widest    => $"{n} cm",
            LeaderboardSearchGoal.Heaviest  => $"{n} g",
            _ => n
        };
    }
    
    
    
    
    //_-----------------------------------
    
    private string GetRankPrefix(string username)
    {
        return username == "Ich" ? "" : "#";
    }

    private void ToggleCategoryMenu()
    {
        _showLeaderboardMenu = !_showLeaderboardMenu;
    }
    
    private void SelectCategory(LeaderboardDto leaderboard)
    {
        _currentLeaderboard = leaderboard;
        _showLeaderboardMenu = false;
    }

    // --- Navigations-Methoden ---
    private void ToggleLogoutMenu()
    {
        _showLogout = !_showLogout;
    }
    
    private void GoToProfile(string username)
    {
        string userUrl = username.TrimStart('@');
        if (username.ToLower() == "ich")
        {
            Nav.NavigateTo("/ProfilTest");
        }
        else
        {
            Nav.NavigateTo($"/profil/{userUrl}");
        }
    }
    
    private void GoToMatches() => Nav.NavigateTo("/matches");
    private void GoToMainpage() => Nav.NavigateTo("/startseite");
    private void GoToProfile() => Nav.NavigateTo("/ProfilTest");
}
