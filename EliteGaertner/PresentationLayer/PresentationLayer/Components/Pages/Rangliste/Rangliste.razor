@page "/Rangliste"
@using PresentationLayer.Services
@using PresentationLayer.Shared
@using PresentationLayer.State
@using AppLogic.Interfaces
@using AppLogic.Services
@using DataManagement.Interfaces

@inject ILeaderBoardDbs LeaderBoardDbs
@inject CurrentProfileState CurrentProfile
@inject SessionService Session
@inject NavigationManager Nav
@inject ILogger<Rangliste> Logger

<link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght=600&display=swap" rel="stylesheet">


<div class="page-container background-style">
    
    <header class="top-bar">
        
        @* Linker Platzhalter da sich sonst das Men√ºIcon nach links verschiebt *@
        <div class="header-left-spacer"></div>

        @* Mitte (wird durch CSS absolut zentriert) *@
        <h1 class="page-title">Ranglisten</h1>

        @* Rechte Seite *@
        <div class="header-right-group" style="display: flex; align-items: center; gap: 20px;">
            @if (!string.IsNullOrEmpty(CurrentProfile.UserName))
            {
                <span class="logged-in-user" style="font-weight: bold; font-size: 1.5rem;">
                    üë§ @($"@{CurrentProfile.UserName}")
                </span>
            }
            <div class="menu-icon-container" @onclick="ToggleLogoutMenu">
                <span class="menu-icon">‚ò∞</span>
            </div>
        </div>
    </header>
    
    @if (_showLogout)
    {
        <div class="logout-menu admin-menu-ext">
            <p class="logout-link" @onclick="Session.Logout">Logout ‚ûú]</p>  
            <div class="admin-header" @onclick="NavigateToAboutUs">
                <span>‚ÑπÔ∏è √úber uns</span>
            </div>
        </div>
    }


    <div class="scroll-content rangliste-content">

        <div class="rangliste-card comic-box-card">
            <div class="category-selector">
                <span class="current-category">@_currentLeaderboard.LeaderboardTitle</span>
                <span class="dropdown-arrow" @onclick="ToggleCategoryMenu">‚ñº</span>
            </div>

            @if (_showLeaderboardMenu)
            {
            <div class="category-dropdown-menu comic-box-dropdown">
                @foreach (var cat in _leaderboardList)
                {
                <div class="dropdown-item" @onclick="() => SelectCategory(cat)">
                    @cat.LeaderboardTitle
                </div>
                }
            </div>
            }
            
            <div class="trophy-icon">
                <img src="pictures/Rangliste.png" alt="Rangliste" height="80" /> 
            </div>

            @foreach (var entry in _currentLeaderboard.Entries)
            {
                <div class="rank-entry @GetRankCssClass(entry.Rank)" style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
                    <div class="rank-info" @onclick="() => GoToProfile(entry.ProfileId)">
                        <span class="rank-number">#@entry.Rank</span>
                        <span class="username-display">@entry.UserName</span>
                    </div>
                    <div class="rank-value" style="margin-left:auto; white-space:nowrap;">
                        <span style="font-weight:600;">@FormatValue(entry.Value, _currentLeaderboard.Goal)</span>
                    </div>
                </div>
            }
        </div>
        
        @* Meine Platzierung *@
        @if (_currentLeaderboard?.PersonalEntry is not null && _currentLeaderboard.PersonalEntry.Rank > 0)
        {
            <div class="rangliste-card comic-box-card my-rank-card">
                <div class="rank-entry current-user-rank" style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
                    <div class="rank-info">
                        <span class="rank-number">#@_currentLeaderboard.PersonalEntry.Rank</span>
                        <span class="username-display">@_currentLeaderboard.PersonalEntry.UserName</span>
                    </div>
                    <div class="rank-value" style="margin-left:auto; white-space:nowrap;">
                        @* Value ist je nach Goal Likes / cm / g *@
                        <span style="font-weight:600;">@FormatValue(_currentLeaderboard.PersonalEntry.Value, _currentLeaderboard.Goal)</span>
                    </div>
                </div>
            </div>
        }
        else
        {
            <div class="rangliste-card comic-box-card my-rank-card">
                <div class="rank-entry default-rank">
                    <div class="rank-info">
                        <span class="username-display">Keine pers√∂nliche Platzierung f√ºr diese Kategorie.</span>
                    </div>
                </div>
            </div>
        }
    </div>

    <footer class="bottom-nav">
        <div class="nav-item active" @onclick="GoToMatches">
            <img src="pictures/MatchesIcon.png" alt="Matches" height="40" />
            <span>Matches</span>
        </div>

        <div class="nav-item" @onclick="GoToMainpage">
            <img src="pictures/EliteG√§rtner_logo.png" alt="EliteG√§rtner" height="40" />
            <span class="elitegaertner-title mt-2" style="font-weight: 600; font-size: 1.0rem">EliteG√§rtner.</span>
        </div>

        <div class="nav-item" @onclick="GoToProfile">
            <img src="pictures/Profil_04.png" alt="Profile" height="40" />
            <span>Profil</span>
        </div>
    </footer>
</div>

@code {
    
    // ----------------------------
    // UI State
    // ----------------------------
    private string _loggedInUserName = "";
    
    private bool _showLogout = false; 
    private bool _showLeaderboardMenu = false;
    private List<LeaderboardDto> _leaderboardList = new();
    private LeaderboardDto _currentLeaderboard;
    

    protected override void OnInitialized()
    {
        Logger.LogInformation("Rangliste: OnInitialized started");
        
        //√úberpr√ºfung
        //Wenn kein Profil im CurrentProfileState -> zur√ºck zur Startseite
        if (CurrentProfile.LoggedInProfile is null)
        {
            Logger.LogWarning("Rangliste: No logged-in profile found -> navigating to '/'");
            Nav.NavigateTo("/");
            return;
        }
        
        Logger.LogInformation(
            "Rangliste: Building leaderboards for ProfileId={ProfileId}. Categories={CategoryCount}",
            CurrentProfile.ProfileId,
            LeaderBoardCategories.Leaderboards.Count);
        
        //Er erstellt hier aus LeaderBoardCategories die Leaderboards die wir ben√∂tigen
        foreach (var leaderboard in LeaderBoardCategories.Leaderboards)
        {
            var service = new LeaderboardService(
                leaderboard.LeaderboardTitle,
                leaderboard.LeaderboardId,
                CurrentProfile.ProfileId.Value,
                leaderboard.TagId,
                leaderboard.Goal,
                LeaderBoardDbs
            );
            Logger.LogDebug(
                "Rangliste: Loading leaderboard '{Title}' (Id={LeaderboardId}, TagId={TagId}, Goal={Goal})",
                leaderboard.LeaderboardTitle,
                leaderboard.LeaderboardId,
                leaderboard.TagId,
                leaderboard.Goal);

            _leaderboardList.Add(service.GetLeaderBoardDto());
            Logger.LogDebug(
                "Rangliste: Loaded leaderboard '{Title}'. Entries={EntriesCount}. HasPersonalEntry={HasPersonalEntry}",
                _leaderboardList[^1].LeaderboardTitle,
                _leaderboardList[^1].Entries?.Count ?? 0,
                _leaderboardList[^1].PersonalEntry is not null);
        }

        _currentLeaderboard = _leaderboardList.FirstOrDefault();

        if (_currentLeaderboard is null)
        {
            Logger.LogWarning("Rangliste: No leaderboards were built (leaderboard list is empty)");
            _currentLeaderboard = new LeaderboardDto
            {
                LeaderboardTitle = "Rangliste",
                Entries = new List<LeaderboardEntryDto>(),
                Goal = LeaderboardSearchGoal.MostLikes
            };
        }

        Logger.LogInformation(
            "Rangliste: Initial leaderboard selected '{Title}'. Entries={EntriesCount}",
            _currentLeaderboard.LeaderboardTitle,
            _currentLeaderboard.Entries?.Count ?? 0);
    }
    

    private string GetRankCssClass(int rank)
    {
        if (rank == 1) return "rank-1";
        if (rank == 2) return "rank-2";
        if (rank == 3) return "rank-3";
        return "default-rank";
    }

    // Formatiert den Ranglistenwert abh√§ngig vom Ziel (Likes / cm / g).
    private string FormatValue(float value, LeaderboardSearchGoal goal)
    {
        // Use compact formatting for floats.
        var n = value.ToString("0.##");

        return goal switch
        {
            LeaderboardSearchGoal.MostLikes => $"{n} üíö",
            LeaderboardSearchGoal.Longest   => $"{n} cm",
            LeaderboardSearchGoal.Widest    => $"{n} cm",
            LeaderboardSearchGoal.Heaviest  => $"{n} g",
            _ => n
        };
    }

    private void ToggleCategoryMenu()
    {
        _showLeaderboardMenu = !_showLeaderboardMenu;
        Logger.LogDebug("Rangliste: ToggleCategoryMenu -> ShowMenu={ShowMenu}", _showLeaderboardMenu);
    }
    
    //Weist dem currentLeaderboard die im Men√º ausgew√§hlte Rangliste zu
    private void SelectCategory(LeaderboardDto leaderboard)
    {
        if (leaderboard is null)
        {
            Logger.LogWarning("Rangliste: SelectCategory called with null leaderboard");
            return;
        }

        Logger.LogInformation(
            "Rangliste: Selecting leaderboard '{Title}' (Id={LeaderboardId})",
            leaderboard.LeaderboardTitle,
            leaderboard.LeaderboardId);

        _currentLeaderboard = leaderboard;
        _showLeaderboardMenu = false;
    }

    // --- Navigations-Methoden ---
    private void ToggleLogoutMenu()
    {
        _showLogout = !_showLogout;
        Logger.LogDebug("Rangliste: ToggleLogoutMenu -> ShowLogout={ShowLogout}", _showLogout);
    }
    
    private void GoToProfile(int profileId)
    {
        Logger.LogInformation("Rangliste: Navigating to public profile ProfileId={ProfileId}", profileId);
        Nav.NavigateTo($"/profil/{profileId}");
    }
    
    private void GoToMatches()
    {
        Logger.LogInformation("Rangliste: Navigating to /matches");
        Nav.NavigateTo("/matches");
    }
    
    private void GoToMainpage()
    {
        Logger.LogInformation("Rangliste: Navigating to /startseite");
        Nav.NavigateTo("/startseite");
    }
    
    private void GoToProfile()
    {
        Logger.LogInformation("Rangliste: Navigating to /EigenesUserProfil");
        Nav.NavigateTo("/EigenesUserProfil");
    }
    
    private void NavigateToAboutUs()
    {
        Logger.LogInformation("Rangliste: Navigation -> Ueber-Uns.");
        Nav.NavigateTo("/ueber-uns");
    }
}
