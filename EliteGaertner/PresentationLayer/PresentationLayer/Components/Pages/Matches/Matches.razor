@page "/matches"
@using AppLogic.Interfaces
@using AppLogic.Services
@using DataManagement.Interfaces
@using PresentationLayer.Services
@using PresentationLayer.State
@using Contracts.Data_Transfer_Objects
@using Microsoft.Extensions.Logging
@inject CurrentProfileState CurrentProfile
@inject IHarvestDbs HarvestDbs
@inject IMatchesDbs MatchesDbs
@inject IProfileDbs ProfileDbs
@inject SessionService Session
@inject NavigationManager Nav
@inject ILogger<Matches> Logger
@inject ILoggerFactory LoggerFactory

<link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&display=swap" rel="stylesheet">

<div class="mobile-container background-style">
    <header class="top-bar">
        @* Hier wird .icon-wrapper verwendet *@
        <div class="icon-wrapper left" @onclick="GoToRanks">
            <img src="pictures/Rangliste.png" alt="Rangliste" height="40" />
            <span class="icon-label">Rangliste</span>
        </div>

        <h1 class="page-title">Meine Matches</h1>

        @* HIER: Ersetzt durch den klickbaren Menü-Container *@
        <div class="menu-icon-container">
            <span class="menu-icon" @onclick="ToggleLogoutMenu">☰</span>
        </div>
    </header>

    @* HIER: Dropdown-Menü für Logout *@
    @if (_showLogout)
    {
    <div class="logout-menu">
        <p @onclick="Session.Logout">Logout &lt;</p>
    </div>
    }

    <div class="scroll-content">
        @foreach (var match in _matches)
        {
        <div class="match-card">
            <div class="card-inner match-card-flex">

                <!-- Profilbild links -->
                <div class="match-avatar">
                    <img src="@match.PictureUrl"
                         alt="Profilbild @match.UserName"
                         class="match-avatar-img" />
                </div>

                <!-- Profilinfos rechts -->
                <div class="match-info">
                    <a class="username-link" href="@($"/profil/{match.ProfileId}")">
                        <div class="username">@match.UserName</div>
                    </a>

                    <div class="info-row">
                        <span class="label">Tel:</span> @match.Phone
                    </div>
                    <div class="info-row">
                        <span class="label">E-Mail:</span> @match.Email
                    </div>
                </div>
            </div>
        </div>
        }
    </div>

    <footer class="bottom-nav">
        <div class="nav-item active" @onclick="GoToMatches">
            <img src="pictures/MatchesIcon.png" alt="Matches" height="40" />
            <span>Matches</span>
        </div>

        <div class="nav-item" @onclick="GoToMainpage">
            <img src="pictures/EliteGärtner_logo.png" alt="EliteGärtner" height="40" />
            <span class="elitegaertner-title mt-2" style="font-weight: 600; font-size: 1.0rem">EliteGärtner.</span>
        </div>

        <div class="nav-item" @onclick="GoToProfile">
            <img src="pictures/Profil_04.png" alt="Profile" height="40" />
            <span>Profil</span>
        </div>
    </footer>
</div>

@code {

    private readonly List<UserMatch> _matches = new List<UserMatch>();
    private IMatchManager _matchManager;
    private bool _showLogout = false; 

    
    protected override void OnInitialized()
    {
        Logger.LogInformation("Matches: OnInitialized gestartet.");
        //Überprüfung
        if (CurrentProfile.LoggedInProfile is null)
        {
            Logger.LogWarning("Matches: Kein eingeloggtes Profil gefunden -> Navigation zur Login-Seite.");
            Nav.NavigateTo("/");
            return;
        }

        Logger.LogInformation("Matches: Initialisiere MatchManager für ProfileId={ProfileId} UserName={UserName}.", CurrentProfile.ProfileId, CurrentProfile.UserName);
        Logger.LogDebug("Matches: Übergabe von LoggerFactory an MatchManager.");
        _matchManager = new MatchManager(MatchesDbs, ProfileDbs, HarvestDbs, CurrentProfile.LoggedInProfile, LoggerFactory);

        var matchDtos = _matchManager.GetActiveMatches();
        var matchDtoList = matchDtos?.ToList() ?? new List<PublicProfileDto>();
        Logger.LogInformation("Matches: {Count} aktive Matches aus AppLogic geladen.", matchDtoList.Count);

        foreach (var dto in matchDtoList)
        {
            _matches.Add(new UserMatch
            {
                UserName = dto.UserName,
                PictureUrl = dto.ProfilepictureUrl,
                ProfileId = dto.ProfileId,
                Phone = dto.Phonenumber,
                Email = dto.EMail
            });
            Logger.LogDebug("Matches: Match hinzugefügt -> ProfileId={MatchProfileId} UserName={MatchUserName}.", dto.ProfileId, dto.UserName);
        }
        Logger.LogInformation("Matches: UI-Liste aufgebaut. _matches.Count={Count}.", _matches.Count);
    }

    public record UserMatch
    {
        public string UserName { get; init; }
        public string PictureUrl { get; init; }
        public int ProfileId { get; init; }
        public string Phone { get; init; } 
        public string Email { get; init; } 
    }
    
    // NEU: Logout-Methoden
    private void ToggleLogoutMenu()
    {
        _showLogout = !_showLogout;
        Logger.LogDebug("Matches: Logout-Menü toggled -> ShowLogout={ShowLogout}.", _showLogout);
    }
    
    //Navigation
    private void GoToRanks()
    {
        Logger.LogInformation("Matches: Navigation -> RanglisteTest.");
        Nav.NavigateTo("/Rangliste");
    }
    private void GoToMatches()
    {
        Logger.LogInformation("Matches: Navigation -> Matches.");
        Nav.NavigateTo("/matches");
    }
    private void GoToMainpage()
    {
        Logger.LogInformation("Matches: Navigation -> Startseite.");
        Nav.NavigateTo("/startseite");
    }
    private void GoToProfile()
    {
        Logger.LogInformation("Matches: Navigation -> EigenesUserProfil.");
        Nav.NavigateTo("/EigenesUserProfil");
    }
}
